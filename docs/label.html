<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Parcsafe — 8×2 QR Labels</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
  --rows:8; --cols:2;

  /* Page margins (mm) */
  --page-mt:10mm; --page-mr:8mm; --page-mb:10mm; --page-ml:8mm;

  /* Labels touch each other */
  --gap-x:0mm; --gap-y:0mm;

  /* Label internals */
  --label-pad:4mm;
  --code-font:6.5mm;
  --qr-size:32mm;

  /* Fine offset controls (calibration) */
  --nudge-x:0mm;   /* + moves right, - moves left */
  --nudge-y:0mm;   /* + moves down, - moves up */

  --ink:#0f1b2f; --muted:#667085; --bg:#f5f7f8; --card:#fff;
  --green:#6dbd45; --line:#e6e8eb;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* Header */
header{
  background:#fff;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,.06)
}
header h1{margin:0;font-size:18px}
.btn{
  background:linear-gradient(#7ad354,#5aa83a);
  border:none;color:#0b1f0b;font-weight:700;
  padding:10px 14px;border-radius:10px;cursor:pointer;
  box-shadow:0 6px 14px rgba(109,189,69,.24)
}
.btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* Layout */
main{
  max-width:1200px;margin:20px auto;padding:0 20px;
  display:grid;grid-template-columns:340px 1fr;gap:20px
}

/* Left panel */
.panel{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.06)
}
.panel h2{margin:0 0 10px;font-size:16px}
.search{width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;margin-bottom:10px}
.list{max-height:60vh;overflow:auto;border:1px solid #eef0f3;border-radius:12px;background:#fff}
.item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid #f0f2f5;cursor:pointer}
.item:hover{background:#f7fbf5}
.code{font-weight:700}
.name{color:var(--muted);font-size:12px}
.panel .row{display:flex;gap:8px;margin-top:12px}

/* A4 preview sheet */
.sheet{
  width:210mm; height:297mm;
  background:#fff; margin:0 auto;
  padding:var(--page-mt) var(--page-mr) var(--page-mb) var(--page-ml);
  box-shadow:0 8px 24px rgba(0,0,0,.12);
  overflow:hidden;
}
.grid{
  display:grid;
  width:100%; height:100%;
  grid-template-columns:repeat(var(--cols), calc(100% / var(--cols)));
  grid-template-rows:repeat(var(--rows), calc(100% / var(--rows)));
  gap:var(--gap-y) var(--gap-x);
  transform:translate(var(--nudge-x), var(--nudge-y));
}
.label{
  outline:0.25mm dashed #d9dde3;
  outline-offset:-0.25mm;
  border:none; border-radius:0;
  padding:var(--label-pad);
  display:flex;align-items:center;justify-content:space-between;gap:6mm;
}
.label .codeBig{
  font-weight:800;
  font-size:var(--code-font);
  letter-spacing:.25mm;
  word-break:break-word
}
.label .qrWrap{
  width:var(--qr-size);height:var(--qr-size);
  display:flex;align-items:center;justify-content:center
}
.label canvas{width:100%;height:100%}

/* Print mode */
@media print{
  @page{ size:A4; margin:0 }
  header,.panel{ display:none !important }
  body{ background:#fff }
  .sheet{ box-shadow:none; margin:0 }
  .label{ outline:none }
}
</style>
</head>
<body>

<header>
  <h1>Parcsafe · 8×2 QR Labels</h1>
  <div style="display:flex;gap:8px">
    <button class="btn ghost" id="undoBtn">Undo last</button>
    <button class="btn ghost" id="clearBtn">Clear all</button>
    <button class="btn" id="printBtn">Download PDF</button>
  </div>
</header>

<main>
  <!-- Product picker -->
  <section class="panel">
    <h2>1) Add products to the sheet</h2>
    <input class="search" id="search" placeholder="Search by drawer code or product name…" />
    <div class="list" id="list"></div>
    <div class="row">
      <small class="name">Click a product to place it in the next empty label (row-wise order).</small>
    </div>

    <!-- Calibration panel -->
    <div class="panel" style="margin-top:12px">
      <h2 style="margin-bottom:8px">Calibration</h2>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <label style="font-size:12px;color:#667085">Top (mm)
          <input type="number" step="0.5" id="mt" class="search" style="margin:6px 0 0" value="10">
        </label>
        <label style="font-size:12px;color:#667085">Bottom (mm)
          <input type="number" step="0.5" id="mb" class="search" style="margin:6px 0 0" value="10">
        </label>
        <label style="font-size:12px;color:#667085">Left (mm)
          <input type="number" step="0.5" id="ml" class="search" style="margin:6px 0 0" value="8">
        </label>
        <label style="font-size:12px;color:#667085">Right (mm)
          <input type="number" step="0.5" id="mr" class="search" style="margin:6px 0 0" value="8">
        </label>
        <label style="font-size:12px;color:#667085">Nudge X (mm)
          <input type="number" step="0.1" id="nx" class="search" style="margin:6px 0 0" value="0">
        </label>
        <label style="font-size:12px;color:#667085">Nudge Y (mm)
          <input type="number" step="0.1" id="ny" class="search" style="margin:6px 0 0" value="0">
        </label>
      </div>
      <small class="name">Print at A4, Margins: None, Scale: 100%. Use nudges for fine drift correction.</small>
    </div>
  </section>

  <!-- A4 Sheet -->
  <section>
    <div class="sheet">
      <div id="grid" class="grid"></div>
    </div>
  </section>
</main>

<!-- jsPDF + Nayuki QR (same as product pages) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script type="module">
  import * as m from 'https://cdn.jsdelivr.net/npm/nayuki-qr-code-generator@1.8.0/index.js';
  const lib = (m && m.QrCode) ? m : ((m && m.default && m.default.QrCode) ? m.default : m);
  window.qrcodegen = lib;
</script>

<script>
/* ======= DOM Refs ======= */
const grid = document.getElementById('grid');
const list = document.getElementById('list');
const search = document.getElementById('search');
const undoBtn = document.getElementById('undoBtn');
const clearBtn = document.getElementById('clearBtn');
const printBtn = document.getElementById('printBtn');

/* ======= Logo ======= */
const LOGO_CANDIDATES = ["./parcsafe-logo.png","../parcsafe-logo.png","../../parcsafe-logo.png"];
let logoImg = null;

/* ======= Grid setup ======= */
function ensureGrid(){
  grid.innerHTML='';
  for(let i=0;i<16;i++){
    const cell=document.createElement('div');
    cell.className='label';
    cell.innerHTML = `
      <div class="codeBig" data-code></div>
      <div class="qrWrap"><canvas data-qr width="640" height="640"></canvas></div>
    `;
    grid.appendChild(cell);
  }
}
ensureGrid();

function firstEmptyIndex(){
  const cells=[...grid.querySelectorAll('[data-code]')];
  return cells.findIndex(c => !c.textContent.trim());
}

function generateProductUrl(drawerCode){
  const base = 'https://ramonpertinezsola.github.io/C2_CP2_Web';
  const up = (drawerCode || '').toUpperCase();

  // Prefixos amb dues carpetes (afegir-ne més si en tens)
  const TWO_LEVEL = ['C2_CP2']; // "C2_CP2_…" → "/C2/CP2/fitxes/…"
  for (const p of TWO_LEVEL) {
    if (up.startsWith(p + '_')) {
      const folder = p.replace('_','/');             // "C2/CP2"
      return `${base}/${folder}/fitxes/${drawerCode}.html`;
    }
  }

  // Resta de casos → una sola carpeta
  const prefix = up.split('_')[0];                   // p.ex. "A1", "C3", "D2"…
  let folder = prefix;

  // Per a A* i B* la carpeta és només la lletra
  if (/^[AB]\d+$/i.test(prefix)) folder = prefix[0];

  // Exemples resultants:
  //  A1_0      → /A/fitxes/A1_0.html
  //  C3_5_I    → /C3/fitxes/C3_5_I.html
  //  D2_10_A   → /D2/fitxes/D2_10_A.html
  return `${base}/${folder}/fitxes/${drawerCode}.html`;
}


function loadLogo(){
  return new Promise(resolve=>{
    let i=0;
    const tryNext=()=>{
      if(i>=LOGO_CANDIDATES.length) return resolve(null);
      const img=new Image(); img.crossOrigin='anonymous';
      img.onload=()=>resolve(img);
      img.onerror=()=>{i++; tryNext();};
      img.src=LOGO_CANDIDATES[i];
    };
    tryNext();
  });
}

async function drawQR(canvas, url){
  while(!(window.qrcodegen && window.qrcodegen.QrCode)) {
    await new Promise(r=>setTimeout(r,20));
  }
  const size = canvas.width;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size);

  const ecc = qrcodegen.QrCode.Ecc.HIGH || qrcodegen.QrCode.Ecc.H;
  const qr = qrcodegen.QrCode.encodeText(url, ecc);
  const modules = qr.size, border = 2;
  const ppm = Math.floor(size / (modules + border*2));
  const qrPix = ppm * (modules + border*2);
  const offset = Math.floor((size - qrPix)/2);

  ctx.fillStyle = '#000';
  for(let y=0;y<modules;y++){
    for(let x=0;x<modules;x++){
      if(qr.getModule(x,y)){
        const px = offset + (x+border)*ppm;
        const py = offset + (y+border)*ppm;
        ctx.fillRect(px,py,ppm,ppm);
      }
    }
  }

  if(logoImg === null) logoImg = await loadLogo();
  if(logoImg){
    const box = Math.floor(size * 0.22);
    const cx = size/2, cy = size/2;
    const r = Math.floor(box/2) + 12;
    ctx.save();
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.restore();

    const pad = 16, w = box - pad*2, h = box - pad*2;
    const aspect = logoImg.width / logoImg.height;
    let dw = w, dh = w/aspect; if(dh>h){ dh=h; dw=h*aspect; }
    ctx.drawImage(logoImg, cx-dw/2, cy-dh/2, dw, dh);
  }
}

/* ======= Label placement ======= */
const placedStack = [];

async function placeLabel(drawerCode){
  const idx = firstEmptyIndex();
  if(idx === -1) return;
  const cell = grid.children[idx];
  cell.querySelector('[data-code]').textContent = drawerCode;
  const url = generateProductUrl(drawerCode);
  await drawQR(cell.querySelector('[data-qr]'), url);
  placedStack.push(idx);
}

function clearSheet(){ ensureGrid(); placedStack.length=0; }
function undoLast(){
  const idx = placedStack.pop();
  if(idx===undefined) return;
  const cell = grid.children[idx];
  cell.querySelector('[data-code]').textContent='';
  const ctx = cell.querySelector('[data-qr]').getContext('2d');
  ctx.clearRect(0,0,640,640);
}

/* ======= Actions ======= */
printBtn.onclick = ()=> window.print();
clearBtn.onclick = clearSheet;
undoBtn.onclick = undoLast;

/* ======= CSV Load ======= */
async function loadCSV(){
  const candidates = [
    "./stock.csv","../stock.csv","../../stock.csv",
    "/docs/stock.csv", location.origin + "/docs/stock.csv"
  ];
  for(const url of candidates){
    try{
      const res = await fetch(url + "?t=" + Date.now());
      if(res.ok){
        const txt = await res.text();
        if(txt.includes('drawerCode')) return txt;
      }
    }catch{}
  }
  throw new Error("Failed to load stock.csv");
}

function parseCSV(txt){
  const rows = txt.trim().split(/\r?\n/);
  const head = rows[0].split(',').map(s=>s.trim());
  return rows.slice(1).map(line=>{
    const cols = line.split(',');
    const obj={}; head.forEach((h,i)=>obj[h]= (cols[i]||'').trim());
    return obj;
  }).filter(r=>r.drawerCode);
}

function renderList(items){
  list.innerHTML='';
  for(const r of items){
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div>
        <div class="code">${r.drawerCode}</div>
        <div class="name">${r.productName||''}</div>
      </div>
      <button class="btn">Add</button>
    `;
    div.querySelector('button').onclick = ()=> placeLabel(r.drawerCode);
    list.appendChild(div);
  }
}

let allItems=[];
loadCSV()
 .then(txt=>{ allItems = parseCSV(txt); renderList(allItems); })
 .catch(()=>{ list.innerHTML = '<div class="item"><div>stock.csv not found</div></div>'; });

search.addEventListener('input', ()=>{
  const q = search.value.trim().toLowerCase();
  if(!q) return renderList(allItems);
  const f = allItems.filter(r =>
    (r.drawerCode||'').toLowerCase().includes(q) ||
    (r.productName||'').toLowerCase().includes(q)
  );
  renderList(f);
});

/* ======= Calibration Controls ======= */
const mt=document.getElementById('mt'), mr=document.getElementById('mr'),
      mb=document.getElementById('mb'), ml=document.getElementById('ml'),
      nx=document.getElementById('nx'), ny=document.getElementById('ny');

function applyCalib(){
  const r = document.documentElement.style;
  if(mt) r.setProperty('--page-mt', `${+mt.value||0}mm`);
  if(mr) r.setProperty('--page-mr', `${+mr.value||0}mm`);
  if(mb) r.setProperty('--page-mb', `${+mb.value||0}mm`);
  if(ml) r.setProperty('--page-ml', `${+ml.value||0}mm`);
  if(nx) r.setProperty('--nudge-x', `${+nx.value||0}mm`);
  if(ny) r.setProperty('--nudge-y', `${+ny.value||0}mm`);
}
[mt,mr,mb,ml,nx,ny].forEach(el => el && el.addEventListener('input', applyCalib));
applyCalib();
</script>
</body>
</html>
