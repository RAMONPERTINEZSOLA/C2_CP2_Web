<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>C3_1_VI</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      max-width: 800px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    a.button {
      display: inline-block;
      padding: 10px 20px;
      margin-bottom: 30px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .images {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
    .images img {
      max-width: 350px;
      border: 1px solid #ddd;
      padding: 5px;
      background: #f9f9f9;
    }
    .description {
      margin-top: 30px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <a href="../index.html" class="button">‚Üê Back to index</a>

  <h1>Drawer: C3_1_VI</h1>
  <p id="product-name"><strong>Product Name:</strong> loading...</p>
  <p id="product-code"><strong>Product Code:</strong> loading...</p>

  <div class="images">
  <div>
    <p><strong>Drawer image:</strong></p>
    <img src="../images/C3_1_VI.jpg" alt="Drawer image" />
  </div>
  <div>
    <p><strong>Drawer Location:</strong></p>
    <img src="../images/C3_bluedrawer_1R.png" alt="Drawer Location" />
    <img src="../images/C3_rack_C3_1_VI.jpg" alt="Drawer Location" />
  </div>
</div>

  <div class="description">
    <p><strong>Description:</strong> <span id="description-text">loading...</span></p>
  </div>

  <h2 id="stock-display" style="font-size: 40px; margin-top: 40px; text-align: center;">Loading stock...</h2>

  <style>
    .stock-ui{margin:20px 0;padding:16px;border:1px solid #ddd;border-radius:12px;background:#fafafa}
    .stock-ui .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .stock-ui button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;background:#0d6efd;color:#fff;font-weight:600}
    .stock-ui button.secondary{background:#6c757d}
    .stock-ui .pill{padding:6px 10px;border-radius:999px;background:#e9ecef;font-variant-numeric:tabular-nums}
    .stock-ui input[type="number"]{width:120px;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
    .stock-ui .save{background:#198754}
    .stock-ui .danger{background:#dc3545}
    .stock-ui .warn{margin-top:12px;padding:10px 14px;border-radius:10px;background:#ffe3e3;color:#c1121f;font-weight:700;display:none}
    .stock-ui .warn.pulse{display:block;animation:pulse 1s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,53,69,.7)}70%{box-shadow:0 0 0 10px rgba(220,53,69,0)}100%{box-shadow:0 0 0 0 rgba(220,53,69,0)}}
  </style>

  <div class="stock-ui" id="stockUI">
    <div class="row">
      <span class="pill">Current: <strong id="curQty">‚Äì</strong></span>
      <span class="pill">Change: <strong id="delta">0</strong></span>
      <span class="pill">New: <strong id="newQty">‚Äì</strong></span>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="minusBtn">‚àí1</button>
      <button id="plusBtn">+1</button>
      <label>Exact: <input id="exactInput" type="number" min="0" step="1" /></label>
      <button class="secondary" id="resetBtn">Reset</button>
      <button class="save" id="saveBtn">Save</button>
    </div>
    <div class="warn" id="minWarn">‚ö†Ô∏è Minimum stock reached!</div>
  </div>


  <script>
    const drawerCode = "C3_1_VI";

    fetch('../../stock.csv')
      .then(res => {
        if (!res.ok) throw new Error("‚ùå Failed to load CSV file. Status: " + res.status);
        return res.text();
      })
      .then(csv => {
        const rows = csv.trim().split("\n");
        const headers = rows[0].split(",");
        const data = rows.slice(1).map(row => {
          const values = row.split(",");
          return headers.reduce((obj, header, idx) => {
            obj[header.trim()] = values[idx] ? values[idx].trim() : "";
            return obj;
          }, {});
        });

        const match = data.find(row => row.drawerCode === drawerCode);
        if (!match) throw new Error("‚ùå Drawer not found in CSV.");

        document.getElementById("product-name").innerHTML = `<strong>Product Name:</strong> ${match.productName}`;
        document.getElementById("product-code").innerHTML = `<strong>Product Code:</strong> ${match.productCode}`;
        document.getElementById("description-text").textContent = match.description;
        \1
        window.__drawerCode = drawerCode;
        window.__initialStock = parseInt(match.stockQty || "0", 10);
        if (window.setupStockUI) window.setupStockUI(window.__initialStock, window.__drawerCode);
      })
      .catch(err => {
        document.getElementById("stock-display").innerText =
          "‚ùå Error loading stock: " + err.message;
      });
  </script>

  <script>
    (function(){
      const MIN_STOCK = 10;
      const WEBHOOK_URL = ""; // TODO: set your n8n webhook URL here

      function setupStockUI(initialQty, drawerCode){
        const ui = document.getElementById('stockUI');
        if(!ui) return;
        const curEl = document.getElementById('curQty');
        const deltaEl = document.getElementById('delta');
        const newEl = document.getElementById('newQty');
        const minus = document.getElementById('minusBtn');
        const plus = document.getElementById('plusBtn');
        const exact = document.getElementById('exactInput');
        const reset = document.getElementById('resetBtn');
        const save = document.getElementById('saveBtn');
        const warn = document.getElementById('minWarn');

        let cur = Number.isFinite(initialQty)? initialQty : 0;
        let delta = 0;

        function refresh(){
          curEl.textContent = cur;
          deltaEl.textContent = delta>0? '+'+delta: delta;
          const nv = cur + delta;
          newEl.textContent = nv;
          exact.value = nv;
          const stockH2 = document.getElementById('stock-display');
          if(stockH2){ stockH2.textContent = 'üì¶ STOCK: ' + nv; }
          if(nv < MIN_STOCK){
            warn.classList.add('pulse');
          } else {
            warn.classList.remove('pulse');
            warn.style.display = 'none'; // still hidden unless pulse active
          }
        }

        minus.addEventListener('click', ()=>{ delta -= 1; refresh(); });
        plus.addEventListener('click', ()=>{ delta += 1; refresh(); });
        exact.addEventListener('input', ()=>{
          const val = parseInt(exact.value, 10);
          if(!isNaN(val)){ delta = val - cur; refresh(); }
        });
        reset.addEventListener('click', ()=>{ delta = 0; refresh(); });

        save.addEventListener('click', async ()=>{
          const newVal = cur + delta;
          const ok = confirm('Est√†s modificant la quantitat de material. Segur que vols guardar?');
          if(!ok) return;
          try{
            // local persistence (fallback)
            localStorage.setItem('stock:'+drawerCode, String(newVal));

            // optional webhook for backend update
            if(WEBHOOK_URL){
              await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                  drawerCode,
                  oldQty: cur,
                  change: delta,
                  newQty: newVal,
                  updatedAt: new Date().toISOString()
                })
              });
            }

            cur = newVal;
            delta = 0;
            refresh();
            alert('‚úîÔ∏è Quantitat actualitzada.' + (newVal < MIN_STOCK ? ' ‚ö†Ô∏è STOCK M√çNIM!' : ''));
          }catch(e){
            alert('‚ùå Error guardant: ' + e.message);
          }
        });

        // Load local override if any (useful until backend is wired)
        const saved = localStorage.getItem('stock:'+drawerCode);
        if(saved !== null){
          cur = parseInt(saved,10);
        }
        refresh();
      }

      // Expose to page
      window.setupStockUI = setupStockUI;
    })();
  </script>

</body>
</html>
