<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parcsafe Stock Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Font Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f1b2f; --muted:#667085; --line:#e6e8eb;
      --brand:#6dbd45; --brand-2:#5aa83a; --bg:#f4f6f8; --card:#fff;
      --danger:#c62828; --ok:#2e7d32; --shadow:0 4px 10px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); margin:0; color:var(--ink);
    }
    header{background:#fff; padding:20px 0; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,.06)}
    header img{height:120px}

    main{max-width:1000px; margin:36px auto; padding:0 20px}

    /* Top actions */
    .actions{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .left-actions{display:flex; gap:12px; align-items:center}

    /* Botons nous (capsa de pastilla, subtil gradient) */
    .btn{
      position:relative;
      display:inline-flex; align-items:center; gap:10px;
      padding:12px 18px; border-radius:999px;
      border:1px solid var(--line);
      background:linear-gradient(#ffffff,#f9fbf9);
      color:var(--ink); text-decoration:none; cursor:pointer;
      box-shadow:var(--shadow); font-weight:600; transition:transform .15s, box-shadow .15s, filter .15s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.10)}
    .btn:active{transform:translateY(0); filter:saturate(1.1)}
    .btn svg{width:18px; height:18px}
    .btn.primary{
      background:linear-gradient(#7ad354,#65c144);
      border-color:#58a33b; color:#0b1f0b;
    }
    .btn.primary:hover{background:linear-gradient(#6fcb4d,#5ab93e)}

    .search{flex:1; min-width:260px}
    .search input{
      width:100%; padding:14px 16px; font-size:16px; border-radius:12px; border:1px solid var(--line);
      background:#fff
    }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}

    /* Grid */
    .grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:20px; margin-top:24px;
    }
    .card{
      background:var(--card); padding:40px 20px; text-align:center; font-size:20px; border-radius:14px;
      color:#004d40; font-weight:700; text-decoration:none; box-shadow:var(--shadow);
      transition:transform .2s, box-shadow .2s, background .2s;
      border:1px solid var(--line);
    }
    .card:hover{transform:translateY(-4px); box-shadow:0 6px 16px rgba(0,0,0,.12); background:#eaf7e8}

    ul#resultsList{list-style:none; padding-left:0; margin-top:14px}
    ul#resultsList li a{display:block; padding:10px; background:#fff; margin-bottom:10px; border-radius:10px; color:#00796b; text-decoration:none; box-shadow:var(--shadow)}

    footer{text-align:center; margin:60px 0 20px; font-size:13px; color:#888}
    .hide{display:none}
  </style>
</head>
<body>
  <header>
    <img src="PARCsafe-[369]-BP-2022.png" alt="Parcsafe Logo">
  </header>

  <main>
    <!-- Top actions: Upload / Download + Search -->
    <div class="actions">
      <div class="left-actions">
        <button class="btn primary" id="btnUpload" title="Upload stock.csv al repositori">
          <!-- icon upload -->
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 16V4m0 0l-4 4m4-4l4 4M4 16v4h16v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Upload STOCK
        </button>

        <a class="btn" id="btnDownload" href="#" title="Descarrega l'últim stock.csv">
          <!-- icon download -->
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v12m0 0l-4-4m4 4l4-4M4 4v4h16V4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Download STOCK
        </a>
        <input type="file" id="fileInput" accept=".csv,text/csv" class="hide" />
      </div>

      <div class="search">
        <input type="text" id="searchBox" placeholder="Search for any item (e.g., C4_3_II)..." />
        <div class="status" id="statusLine">Ready.</div>
      </div>
    </div>

    <!-- Results (search) -->
    <ul id="resultsList"></ul>

    <!-- Grid de categories -->
    <div class="grid">
      <a class="card" href="A/index.html">A</a>
      <a class="card" href="B/index.html">B</a>
      <a class="card" href="C2/CP2/index.html">C2 – CP2</a>
      <a class="card" href="C3/index.html">C3</a>
      <a class="card" href="C4/index.html">C4</a>
      <a class="card" href="C5/index.html">C5</a>
      <a class="card" href="D1/index.html">D1</a>
      <a class="card" href="D2/index.html">D2</a>
      <a class="card" href="E1/index.html">E1</a>
      <a class="card" href="E2/index.html">E2</a>
      <a class="card" href="E3/index.html">E3</a>
      <a class="card" href="F/index.html">F</a>
    </div>
  </main>

  <footer>© 2025 Parcsafe · All rights reserved</footer>

  <script>
    // ======== CONFIG ========
    const WORKER_BASE = 'https://stock-api.ramonpertinez.workers.dev'; // <-- la teva URL base (sense barra final)
    // Rutes candidates per al CSV (evitar 404 segons context)
    const STOCK_CANDIDATES = [
      'docs/stock.csv',
      '/C2_CP2_Web/docs/stock.csv',
      '/docs/stock.csv',
      'stock.csv'
    ];
    // ========================

    const statusLine  = document.getElementById('statusLine');
    const fileInput   = document.getElementById('fileInput');
    const btnUpload   = document.getElementById('btnUpload');
    const btnDownload = document.getElementById('btnDownload');

    function setStatus(msg, type=''){
      statusLine.textContent = msg;
      statusLine.className = 'status' + (type ? ' ' + type : '');
    }

    async function fetchWithFallback(paths){
      let lastErr = null;
      for(const p of paths){
        const url = new URL(p, window.location.href);
        try{
          const res = await fetch(`${url}?cb=${Date.now()}`, { cache:'no-store' });
          if(res.ok) return res;
          lastErr = new Error(`HTTP ${res.status}`);
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('Not found');
    }

    // Download
    btnDownload.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        setStatus('Downloading stock.csv…');
        const res  = await fetchWithFallback(STOCK_CANDIDATES);
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'stock.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setStatus('Download completed ✅', 'ok');
      }catch(err){
        console.error(err);
        setStatus('Download failed: ' + err.message, 'err');
      }
    });

    // Upload → Worker /stock/file (text/plain)
    btnUpload.addEventListener('click', ()=> fileInput.click());

    fileInput.addEventListener('change', async ()=>{
      const file = fileInput.files[0];
      if(!file) return;
      if(!file.name.toLowerCase().endsWith('.csv')){
        setStatus('Please select a .csv file.', 'err');
        fileInput.value = '';
        return;
      }
      try{
        setStatus('Uploading stock.csv…');
        const txt = await file.text(); // CSV cru (pot tenir accents)

        const res = await fetch(`${WORKER_BASE}/stock/file`, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: txt,
          mode: 'cors'
        });

        const data = await res.json().catch(()=> ({}));
        if(!res.ok || data?.error){
          throw new Error(data?.error || `HTTP ${res.status}`);
        }
        setStatus('Upload OK ✅ — stock.csv.', 'ok');
        fileInput.value = '';
      }catch(err){
        console.error(err);
        setStatus('Upload failed: ' + err.message, 'err');
      }
    });

    // ======== Search ========
    const allFitxes = [];
    function addFitxes(list){ allFitxes.push(...list); }

    const searchBox   = document.getElementById('searchBox');
    const resultsList = document.getElementById('resultsList');

    function updateResults(){
      const q = searchBox.value.toLowerCase().trim();
      resultsList.innerHTML = '';
      if(!q) return;

      const filtered = allFitxes.filter(f => f.name.toLowerCase().includes(q));
      if(filtered.length === 0){
        const li = document.createElement('li'); li.textContent = 'No results found'; resultsList.appendChild(li); return;
      }
      filtered.forEach(f=>{
        const li = document.createElement('li');
        const a = document.createElement('a'); a.href = f.path; a.textContent = f.name;
        li.appendChild(a); resultsList.appendChild(li);
      });
    }
    searchBox.addEventListener('input', updateResults);
  </script>

  <!-- Fitxes -->
  <script src="A/fitxes.js"></script>
  <script src="B/fitxes.js"></script>
  <script src="C2/CP2/fitxes.js"></script>
  <script src="C3/fitxes.js"></script>
  <script src="C4/fitxes.js"></script>
  <script src="C5/fitxes.js"></script>
  <script src="D1/fitxes.js"></script>
  <script src="D2/fitxes.js"></script>
  <script src="E1/fitxes.js"></script>
  <script src="E2/fitxes.js"></script>
  <script src="E3/fitxes.js"></script>
  <script src="F/fitxes.js"></script>

  <!-- ─── Parcsafe README Access Button ──────────────────────────────── -->
<div style="text-align:center; margin:60px 0 40px;">
  <a href="readme.html" 
     style="display:inline-block; background:#6dbd45; color:#fff; 
            font-family:'Poppins',sans-serif; font-weight:600;
            padding:14px 28px; border-radius:12px; text-decoration:none;
            box-shadow:0 6px 14px rgba(109,189,69,.25); transition:.3s;">
    📘 View Full Documentation
  </a>
</div>

</body>
</html>
