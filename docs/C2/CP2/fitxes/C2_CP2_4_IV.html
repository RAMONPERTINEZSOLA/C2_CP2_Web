<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C2_CP2_4_IV ‚Äî Parcsafe Drawer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#6dbd45; --green-2:#5aa83a; --ink:#222; --muted:#667085;
      --bg:#f5f7f8; --card:#ffffff; --line:#e6e8eb; --danger:#b3261e;
      --brand-shadow:0 6px 24px rgba(109,189,69,.18); --radius:16px;
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .container{max-width:1100px;margin:40px auto;padding:0 20px}

    header.bar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .back{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:var(--card);text-decoration:none;color:var(--ink);font-weight:600}
    .logo{height:64px;object-fit:contain}
    .brand{display:flex;align-items:center;gap:10px}

    h1.title{font-size:26px;margin:10px 0 6px 0;display:flex;align-items:center;gap:10px}
    .drawer-code{font-size:12px;color:#475467;background:#eef4ff;border:1px solid #d6e4ff;padding:4px 8px;border-radius:999px;font-weight:700;letter-spacing:.3px}

    .meta{display:grid;grid-template-columns:1fr auto;gap:6px 18px;margin-bottom:6px;align-items:center}
    .meta .codeWrap{display:flex;align-items:center;gap:10px}
    .meta strong{color:var(--ink)}
    .btn{border:none;border-radius:12px;padding:8px 12px;font-weight:600;cursor:pointer;background:var(--green);color:#fff;box-shadow:var(--brand-shadow);transition:transform .04s ease, background .2s ease}
    .btn:hover{background:var(--green-2)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#98a2b3} .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--brand-shadow)}
    .card h3{margin:0 0 12px 0;font-size:16px}
    .card .imgwrap{border:1px dashed #cdd4d9;background:#fafafa;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:270px;overflow:hidden}
    .card img{max-width:100%;height:auto;display:block}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .spacer{height:10px}

    .stock-ui{margin:20px 0;padding:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--card);box-shadow:var(--brand-shadow)}
    .stock-ui .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .stock-ui button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;background:var(--green);color:#fff;font-weight:600}
    .stock-ui button.secondary{background:#6c757d}
    .stock-ui .pill{padding:6px 10px;border-radius:999px;background:#eef2f6;border:1px solid #dde3ea;font-variant-numeric:tabular-nums}
    .stock-ui input[type="number"]{width:120px;padding:8px 10px;border:1px solid #c9cfd6;border-radius:8px}
    .stock-display{font-size:40px;margin:24px 0;text-align:center}
    .stock-ui .warn{margin-top:12px;padding:10px 14px;border-radius:10px;background:#ffe3e3;color:var(--danger);font-weight:700;display:none;border:1px solid #f3b5b5}
    .stock-ui .warn.pulse{display:block;animation:pulse 1s infinite}
    .stock-ui .warn.pulse::before{content:"‚ùó‚ùó"; margin-right:8px; display:inline-block; animation:wiggle .8s infinite;}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,53,69,.35)}70%{box-shadow:0 0 0 10px rgba(220,53,69,0)}100%{box-shadow:0 0 0 0 rgba(220,53,69,0)}}
    @keyframes wiggle{0%{transform:translateY(0)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}

    #toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background-color:#198754;color:white;padding:10px 20px;border-radius:10px;font-weight:700;display:none;animation:fade 3s ease forwards;z-index:1000}
    @keyframes fade{
      0%{opacity:0;transform:translate(-50%,10px)}
      10%{opacity:1;transform:translate(-50%,0)}
      90%{opacity:1;transform:translate(-50%,0)}
      100%{opacity:0;transform:translate(-50%,10px)}
    }

    /* ===== Improved Modal Style ===== */
    dialog.modal{border:none;border-radius:22px;padding:0;max-width:760px;width:96%;box-shadow:0 24px 80px rgba(16,24,40,.35);background:linear-gradient(180deg,#fff, #f9fbfa)}
    dialog.modal::backdrop{background:rgba(10,12,14,.45);backdrop-filter:blur(3px)}
    .modal .hd{padding:22px 24px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:#f0f7ec}
    .modal .hd strong{font-size:18px}
    .close-x{background:transparent;border:none;font-size:24px;cursor:pointer;line-height:1}
    .modal .bd{padding:22px 24px;display:grid;grid-template-columns:1fr 1fr;gap:20px 22px}
    .modal .bd .fld--wide{grid-column:1 / -1}
    .fld{display:flex;flex-direction:column;gap:6px}
    .fld label{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px}
    .fld input,.fld textarea{padding:14px 16px;border-radius:14px;border:1px solid #d0d5dd;background:#fff;font-family:inherit;font-size:16px;outline:none}
    .fld input:focus,.fld textarea:focus{border-color:#b7df9f; box-shadow:0 0 0 3px rgba(109,189,69,.18)}
    .fld textarea{min-height:140px;resize:vertical}
    .note{color:var(--muted);font-size:12px;margin-top:6px;grid-column:1 / -1}
    .modal .ft{padding:18px 24px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;background:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-weight:700;background:#eef2f6;border:1px solid #dde3ea;padding:2px 6px;border-radius:6px}
  </style>

  <!-- üîß Override petit per assegurar el di√†leg al davant -->
 <style>
    dialog.modal{ z-index: 10010 !important; }
    dialog.modal::backdrop{ z-index: 10000 !important; }
  </style>
  
<!-- PDF (CDN) + QR (LOCAL COMPILAT) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- ‚úÖ QR UMD per navegador (substitueix l'script local) -->
  <script type="module">
    import * as m from 'https://cdn.jsdelivr.net/npm/nayuki-qr-code-generator@1.8.0/index.js';

    // üîß Shim robust: detecta on viu QrCode i exposa-ho a window.qrcodegen
    const lib =
      (m && m.QrCode) ? m :
      (m && m.default && m.default.QrCode) ? m.default :
      m;

    window.qrcodegen = lib;
  </script>


</head>
<body>
  <div class="container">

    <header class="bar">
      <a class="back" href="../index.html">‚Üê Back to index</a>
      <div class="brand">
        <img class="logo" id="logo" alt="Parcsafe">
      </div>
    </header>

    <h1 class="title">
      Drawer details
      <span class="drawer-code">C2_CP2_4_IV</span>
    </h1>

    <div class="meta">
      <div id="product-name"><strong>Product Name:</strong> loading...</div>
      <div class="codeWrap">
        <div id="product-code"><strong>Product Code:</strong> loading...</div>
        <button class="btn secondary" id="editInfoBtn">‚úèÔ∏è Edit Product Info</button>
        <button class="btn ghost" id="qrBtn" type="button">üìé QR</button>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <h3>Drawer Photo</h3>
        <div class="imgwrap">
          <img id="drawerImg" src="../images/C2_CP2_4_IV.jpg" alt="Drawer image C2_CP2_4_IV" onerror="this.onerror=null; this.src='../../images/C2_CP2_4_IV.jpg';" />
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn" id="uploadPhotoBtn">üñºÔ∏è Update Drawer Photo</button>
          <button class="btn ghost" id="refreshImgBtn">Refresh</button>
          <span class="note">The new image will be renamed to <strong>C2_CP2_4_IV.jpg</strong> automatically.</span>
        </div>
        <input type="file" id="fileInput" accept="image/png,image/jpeg" style="display:none" />
      </div>

      <div class="card">
        <h3>Cabinet Highlight</h3>
        <div class="imgwrap">
          <img id="cabImg" src="../images/C2_CP2_cabinet_C2_CP2_4_IV.png" alt="Cabinet highlight" onerror="this.onerror=null; this.src='../../images/C2_CP2_cabinet_C2_CP2_4_IV.png';" />
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <h3>Description</h3>
      <div id="description-text" style="line-height:1.6">loading...</div>
    </div>

    <div class="stock-display" id="stock-display">Loading stock...</div>

    <div class="stock-ui" id="stockUI">
      <div class="row">
        <span class="pill">Current: <strong id="curQty">‚Äì</strong></span>
        <span class="pill">Change: <strong id="delta">0</strong></span>
        <span class="pill">New: <strong id="newQty">‚Äì</strong></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="minusBtn">‚àí1</button>
        <button id="plusBtn">+1</button>
        <label>Exact: <input id="exactInput" type="number" min="0" step="1" /></label>
        <button class="secondary" id="resetBtn">Reset</button>
        <button class="save" id="saveBtn">Save</button>
      </div>
      <div class="warn" id="minWarn">LOW STOCK ‚Äî minimum 10</div>
    </div>

    <div id="toast"></div>
  </div>

  <!-- Edit Info Modal -->
  <dialog class="modal" id="editModal">
    <form method="dialog" id="editForm">
      <div class="hd">
        <strong>Edit product info</strong>
        <button class="close-x" value="cancel" aria-label="Close">‚úï</button>
      </div>
      <div class="bd">
        <div class="fld">
          <label for="fldName">Product Name</label>
          <input id="fldName" type="text" required />
        </div>
        <div class="fld">
          <label for="fldCode">Product Code</label>
          <input id="fldCode" type="text" required />
        </div>
        <div class="fld fld--wide">
          <label for="fldDesc">Description</label>
          <textarea id="fldDesc" required></textarea>
        </div>
        <div class="note">Tip: press <span class="kbd">Esc</span> to close.</div>
      </div>
      <div class="ft">
        <button class="btn ghost" value="cancel">Cancel</button>
        <button class="btn" id="saveInfoBtn" value="default">Save changes</button>
      </div>
    </form>
  </dialog>

  <!-- QR MODAL -->
  <dialog class="modal" id="qrModal">
    <div class="hd">
      <strong>Product QR</strong>
      <button class="close-x" value="cancel" aria-label="Close" id="qrClose">‚úï</button>
    </div>
    <div class="bd">
      <div class="fld fld--wide" style="align-items:center">
        <canvas id="qrCanvas" width="1024" height="1024" style="max-width:320px; width:100%; height:auto; border:1px dashed #d0d5d0; border-radius:12px; background:#fff"></canvas>
        <div class="note" id="qrUrlNote" style="text-align:center; word-break:break-all"></div>
      </div>
    </div>
    <div class="ft">
      <button class="btn ghost" id="copyLinkBtn" type="button">URL Link</button>
      <button class="btn ghost" id="dlPngBtn" type="button">Download PNG</button>
      <button class="btn" id="dlPdfBtn" type="button">Download PDF</button>
    </div>
  </dialog>

  <script>
    async function ensureQrLib(timeoutMs = 1000) {
  const t0 = performance.now();
  while (!(window.qrcodegen && window.qrcodegen.QrCode)) {
    if (performance.now() - t0 > timeoutMs) throw new Error("QR lib not ready");
    await new Promise(r => setTimeout(r, 20));
    }
  }

    const drawerCode = "C2_CP2_4_IV";
    const STOCK_API = "https://stock-api.ramonpertinez.workers.dev/stock/item";
    const UPLOAD_ENDPOINT = "https://stock-api.ramonpertinez.workers.dev/upload-image";
    const UPDATE_INFO_ENDPOINT = "https://stock-api.ramonpertinez.workers.dev/update-item-info";
    // === QR EST√ÄTIC (canvia-ho si vols un altre text/URL) ===
    const QR_STATIC_VALUE = "https://ramonpertinezsola.github.io/C2_CP2_Web/C2/CP2/fitxes/C2_CP2_4_IV.html";


    // ===== Robust logo loader (header) =====
    (function loadLogo(){
      const logo = document.getElementById('logo');
      const candidates = [
        "../../PARCsafe-[369]-BP-2022.png",
        "../PARCsafe-[369]-BP-2022.png",
        "../../../PARCsafe-[369]-BP-2022.png",
        "../../parcsafe-logo.png",
        "../parcsafe-logo.png",
        "../../../parcsafe-logo.png"
      ];
      let i = 0;
      const tryNext = () => {
        if(i >= candidates.length){ logo.remove(); return; }
        logo.src = candidates[i++];
      };
      logo.onerror = tryNext;
      tryNext();
    })();

    const toast = document.getElementById("toast");
    function showToast(msg, color="#198754"){
      toast.textContent = msg;
      toast.style.backgroundColor = color;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 2600);
    }

    async function loadCSVFromCandidates() {
      const candidates = [
        "../../stock.csv",
        "../stock.csv",
        "../../../stock.csv",
        "./stock.csv",
        "/docs/stock.csv",
        window.location.origin + "/docs/stock.csv",
      ];
      for (const url of candidates) {
        try {
          const res = await fetch(url + "?t=" + Date.now());
          if (res.ok) {
            const txt = await res.text();
            if (txt.includes("drawerCode")) {
              console.log("‚úÖ CSV found at:", url);
              return txt;
            }
          }
        } catch (err) { console.warn("‚ùå Not found:", url); }
      }
      throw new Error("stock.csv not found via any path");
    }

    loadCSVFromCandidates()
      .then(csv => {
        const rows = csv.trim().split("\n");
        const headers = rows[0].split(",");
        const data = rows.slice(1).map(r => {
          const vals = r.split(",");
          return headers.reduce((o, h, i) => { o[h.trim()] = vals[i] ? vals[i].trim() : ""; return o; }, {});
        });
        const match = data.find(r => (r.drawerCode || "").trim() === drawerCode);
        if (!match) throw new Error("Drawer not found");

        document.getElementById("product-name").innerHTML = `<strong>Product Name:</strong> ${match.productName || ""}`;
        document.getElementById("product-code").innerHTML = `<strong>Product Code:</strong> ${match.productCode || ""}`;
        document.getElementById("description-text").textContent = match.description || "";

        const MIN_STOCK = parseInt(match.minStock || "10", 10);
        document.getElementById("stock-display").innerText = "üì¶ STOCK: " + (match.stockQty || "0");
        document.getElementById("minWarn").textContent = `LOW STOCK ‚Äî minimum ${MIN_STOCK}`;
        initStockUI(parseInt(match.stockQty || "0", 10), MIN_STOCK);

        document.getElementById("fldName").value = match.productName || "";
        document.getElementById("fldCode").value = match.productCode || "";
        document.getElementById("fldDesc").value = match.description || "";
      })
      .catch(e => { document.getElementById("stock-display").innerText = "‚ùå Error: " + e.message; });

    function initStockUI(initialQty, MIN_STOCK = 10) {
      const curEl = document.getElementById('curQty');
      const deltaEl = document.getElementById('delta');
      const newEl = document.getElementById('newQty');
      const minus = document.getElementById('minusBtn');
      const plus = document.getElementById('plusBtn');
      const exact = document.getElementById('exactInput');
      const reset = document.getElementById('resetBtn');
      const save = document.getElementById('saveBtn');
      const warn = document.getElementById('minWarn');
      let cur = initialQty, delta = 0;

      function refresh(){
        curEl.textContent = cur;
        deltaEl.textContent = delta > 0 ? '+' + delta : delta;
        const nv = cur + delta;
        newEl.textContent = nv;
        exact.value = nv;
        document.getElementById('stock-display').textContent = 'üì¶ STOCK: ' + nv;
        if (nv < MIN_STOCK) { warn.classList.add('pulse'); warn.style.display='block'; }
        else { warn.classList.remove('pulse'); warn.style.display='none'; }
      }

      minus.addEventListener('click', ()=>{ delta -= 1; refresh(); });
      plus.addEventListener('click', ()=>{ delta += 1; refresh(); });
      exact.addEventListener('input', ()=>{ const v=parseInt(exact.value,10); if(!isNaN(v)){ delta=v-cur; refresh(); }});
      reset.addEventListener('click', ()=>{ delta=0; refresh(); });

      save.addEventListener('click', async ()=> {
        const newVal = cur + delta;
        if(!confirm(`Are you sure you want to update the stock to ${newVal}?`)) return;
        try{
          const r = await fetch(STOCK_API, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ drawerCode, newQty: newVal })
          });
          if (!r.ok) throw new Error(await r.text());
          cur = newVal; delta = 0; refresh();
          showToast('‚úîÔ∏è Stock successfully updated');
        }catch(e){
          console.error(e);
          showToast('‚ùå Error updating stock', '#b3261e');
        }
      });
      refresh();
    }

    // === Upload image ===
    const uploadBtn = document.getElementById('uploadPhotoBtn');
    const refreshImgBtn = document.getElementById('refreshImgBtn');
    const fileInput = document.getElementById('fileInput');
    uploadBtn.addEventListener('click', ()=> fileInput.click());
    refreshImgBtn.addEventListener('click', ()=> {
      const el = document.getElementById('drawerImg');
      el.src = `../images/${drawerCode}.jpg?t=${Date.now()}`;
    });
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      if(!/image\/(jpeg|png)/.test(file.type)) return showToast('Only JPG/PNG allowed', '#b3261e');
      if(file.size > 8*1024*1024) return showToast('Max 8MB image', '#b3261e');
      const fd = new FormData();
      fd.append('image', file);
      fd.append('drawerCode', drawerCode);
      try{
        const r = await fetch(UPLOAD_ENDPOINT, { method:'POST', body: fd });
        if(!r.ok) throw new Error(await r.text());
        showToast('‚úîÔ∏è Image updated successfully');
        const el = document.getElementById('drawerImg');
        el.src = `../images/${drawerCode}.jpg?t=${Date.now()}`;
      }catch(err){
        console.error(err);
        showToast('‚ùå Error uploading image', '#b3261e');
      }finally{ fileInput.value = ''; }
    });

    // === Edit info modal ===
    const editBtn = document.getElementById('editInfoBtn');
    const modal = document.getElementById('editModal');
    const saveInfoBtn = document.getElementById('saveInfoBtn');
    const fldName = document.getElementById('fldName');
    const fldCode = document.getElementById('fldCode');
    const fldDesc = document.getElementById('fldDesc');

    editBtn.addEventListener('click', ()=> modal.showModal());
    modal.addEventListener('click', (e)=>{
      const rect = modal.getBoundingClientRect();
      const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inside) modal.close();
    });
    saveInfoBtn.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const name = fldName.value.trim();
      const code = fldCode.value.trim();
      const desc = fldDesc.value.trim();
      if(!name || !code || !desc){ showToast('Please fill all fields', '#b3261e'); return; }
      try{
        const r = await fetch(UPDATE_INFO_ENDPOINT, {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ drawerCode, productName:name, productCode:code, description:desc })
        });
        if(!r.ok) throw new Error(await r.text());
        document.getElementById("product-name").innerHTML = `<strong>Product Name:</strong> ${name}`;
        document.getElementById("product-code").innerHTML = `<strong>Product Code:</strong> ${code}`;
        document.getElementById("description-text").textContent = desc;
        modal.close();
        showToast('‚úîÔ∏è Product info updated');
      }catch(err){
        console.error(err);
        showToast('‚ùå Error updating info', '#b3261e');
      }
    });

    // ===== QR (qrcodegen local) =====
    const qrBtn = document.getElementById('qrBtn');
    const qrModal = document.getElementById('qrModal');
    const qrClose = document.getElementById('qrClose');
    const qrCanvas = document.getElementById('qrCanvas');
    const dlPngBtn = document.getElementById('dlPngBtn');
    const dlPdfBtn = document.getElementById('dlPdfBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const qrUrlNote = document.getElementById('qrUrlNote');

    // Prova diverses rutes de logo fins que una funcioni
    const LOGO_CANDIDATES = [
      "../../parcsafe-logo.png",
      "../parcsafe-logo.png",
      "../../../parcsafe-logo.png"
    ];

    let qrLogoPromise; // cache perqu√® nom√©s es provi una vegada
    function loadQrLogo() {
      if (qrLogoPromise) return qrLogoPromise;
      qrLogoPromise = new Promise((resolve) => {
        let i = 0;
        const tryNext = () => {
          if (i >= LOGO_CANDIDATES.length) return resolve(null);
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => resolve(img);
          img.onerror = () => { i++; tryNext(); };
          img.src = LOGO_CANDIDATES[i];
        };
        tryNext();
      });
      return qrLogoPromise;
    }

    function currentCleanUrl(){
      return window.location.href.split('#')[0].split('?')[0];
    }

    async function drawQR(url){
      const size = 1024;
      const ctx = qrCanvas.getContext('2d');
      qrCanvas.width = size; qrCanvas.height = size;
      ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0,0,size,size);

      // Genera QR amb la llibreria local
      const ecc = qrcodegen.QrCode.Ecc.HIGH || qrcodegen.QrCode.Ecc.H; // compat
      const qr  = qrcodegen.QrCode.encodeText(url, ecc);
      const modules = qr.size, border = 2;
      const ppm = Math.floor(size / (modules + border*2));
      const qrPix = ppm * (modules + border*2);
      const offset = Math.floor((size - qrPix)/2);

      ctx.fillStyle = '#000000';
      for(let y=0;y<modules;y++){
        for(let x=0;x<modules;x++){
          if(qr.getModule(x,y)){
            const px = offset + (x+border)*ppm;
            const py = offset + (y+border)*ppm;
            ctx.fillRect(px,py,ppm,ppm);
          }
        }
      }

     // Logo central (nom√©s si hi ha logo)
    const logoImg = await loadQrLogo();
    if (logoImg) {
      const logoBox = Math.floor(size * 0.22);
      const cx = size/2, cy = size/2;
      const r = Math.floor(logoBox/2) + 14;

      // disc blanc sota el logo (ara s√≠, nom√©s quan hi ha logo)
      ctx.save();
      ctx.fillStyle = '#FFF';
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();

      const pad = 18;
      const w = logoBox - pad*2;
      const h = logoBox - pad*2;

      const aspect = logoImg.width / logoImg.height;
      let drawW = w, drawH = w / aspect;
      if (drawH > h) { drawH = h; drawW = h * aspect; }

      ctx.drawImage(logoImg, cx - drawW/2, cy - drawH/2, drawW, drawH);
    }
    }

    function safeOpenDialog(dlg){ try{ dlg.showModal(); }catch{ dlg.setAttribute('open',''); } }

    async function openQrModal(){
      qrUrlNote.textContent = QR_STATIC_VALUE;   // (ja el tens est√†tic)
      safeOpenDialog(qrModal);
      await new Promise(r=>requestAnimationFrame(r));
      await ensureQrLib();                        // ‚úÖ espera la llibreria
      await drawQR(QR_STATIC_VALUE);
    }



    qrBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openQrModal(); });
    qrClose?.addEventListener('click', ()=> qrModal.close());
    qrModal?.addEventListener('click', (e)=>{
      const r = qrModal.getBoundingClientRect();
      const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
      if(!inside) qrModal.close();
    });

    // Copiar enlla√ß
    copyLinkBtn?.addEventListener('click', async ()=>{
      const url = QR_STATIC_VALUE;
      try{ await navigator.clipboard.writeText(url); showToast('üîó Enlla√ß copiat'); }
      catch{ const ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('üîó Enlla√ß copiat'); }
    });


    // Descarregar PNG
    dlPngBtn?.addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.href = qrCanvas.toDataURL('image/png');
      a.download = `${drawerCode}_QR.png`;
      a.click();
    });

    // Descarregar PDF
    dlPdfBtn?.addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'mm', format:'A4' });
      const png = qrCanvas.toDataURL('image/png');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 20;
      const box = pageW - margin*2;
      pdf.addImage(png, 'PNG', margin, margin, box, box);
      pdf.setFontSize(11);
      pdf.text(QR_STATIC_VALUE, margin, pageH - margin/2);
      pdf.save(`${drawerCode}_QR.pdf`);
    });

  </script>
</body>
</html>
