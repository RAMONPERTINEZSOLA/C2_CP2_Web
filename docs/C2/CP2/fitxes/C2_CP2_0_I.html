<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C2_CP2_0_I ‚Äî Parcsafe Drawer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#6dbd45; --green-2:#5aa83a; --ink:#222; --muted:#667085;
      --bg:#f5f7f8; --card:#ffffff; --line:#e6e8eb; --danger:#b3261e;
      --brand-shadow:0 6px 24px rgba(109,189,69,.18); --radius:16px;
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .container{max-width:1100px;margin:40px auto;padding:0 20px}

    header.bar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .back{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:var(--card);text-decoration:none;color:var(--ink);font-weight:600}
    .logo{height:28px;object-fit:contain}
    .brand{display:flex;align-items:center;gap:10px}

    h1.title{font-size:26px;margin:10px 0 6px 0;display:flex;align-items:center;gap:10px}
    .drawer-code{font-size:12px;color:#475467;background:#eef4ff;border:1px solid #d6e4ff;padding:4px 8px;border-radius:999px;font-weight:700;letter-spacing:.3px}

    .meta{display:grid;grid-template-columns:1fr auto;gap:6px 18px;margin-bottom:6px;align-items:center}
    .meta .codeWrap{display:flex;align-items:center;gap:10px}
    .meta strong{color:var(--ink)}
    .btn{border:none;border-radius:12px;padding:8px 12px;font-weight:600;cursor:pointer;background:var(--green);color:#fff;box-shadow:var(--brand-shadow);transition:transform .04s ease, background .2s ease}
    .btn:hover{background:var(--green-2)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#98a2b3} .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--brand-shadow)}
    .card h3{margin:0 0 12px 0;font-size:16px}
    .card .imgwrap{border:1px dashed #cdd4d9;background:#fafafa;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:270px;overflow:hidden}
    .card img{max-width:100%;height:auto;display:block}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .spacer{height:10px}

    .stock-ui{margin:20px 0;padding:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--card);box-shadow:var(--brand-shadow)}
    .stock-ui .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .stock-ui button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;background:var(--green);color:#fff;font-weight:600}
    .stock-ui button.secondary{background:#6c757d}
    .stock-ui .pill{padding:6px 10px;border-radius:999px;background:#eef2f6;border:1px solid #dde3ea;font-variant-numeric:tabular-nums}
    .stock-ui input[type="number"]{width:120px;padding:8px 10px;border:1px solid #c9cfd6;border-radius:8px}
    .stock-display{font-size:40px;margin:24px 0;text-align:center}
    .stock-ui .warn{margin-top:12px;padding:10px 14px;border-radius:10px;background:#ffe3e3;color:var(--danger);font-weight:700;display:none;border:1px solid #f3b5b5}
    .stock-ui .warn.pulse{display:block;animation:pulse 1s infinite}
    .stock-ui .warn.pulse::before{content:"‚ùó‚ùó"; margin-right:8px; display:inline-block; animation:wiggle .8s infinite;}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,53,69,.35)}70%{box-shadow:0 0 0 10px rgba(220,53,69,0)}100%{box-shadow:0 0 0 0 rgba(220,53,69,0)}}
    @keyframes wiggle{0%{transform:translateY(0)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}

    #toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background-color:#198754;color:white;padding:10px 20px;border-radius:10px;font-weight:700;display:none;animation:fade 3s ease forwards;z-index:1000}
    @keyframes fade{0%{opacity:0;transform:translate(-50%,10px)}10%{opacity:1;transform:translate(-50%,0)}90%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,10px)}

    /* ===== Improved Modal Style ===== */
    dialog.modal{border:none;border-radius:18px;padding:0;max-width:680px;width:96%;box-shadow:0 24px 80px rgba(16,24,40,.35);background:linear-gradient(180deg,#fff, #f9fbfa)}
    dialog.modal::backdrop{background:rgba(10,12,14,.45);backdrop-filter:blur(3px)}
    .modal .hd{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:#f0f7ec}
    .modal .hd strong{font-size:16px}
    .close-x{background:transparent;border:none;font-size:22px;cursor:pointer;line-height:1}
    .modal .bd{padding:18px 20px;display:grid;grid-template-columns:1fr 1fr;gap:12px 16px}
    .modal .bd .fld--wide{grid-column:1 / -1}
    .fld{display:flex;flex-direction:column;gap:6px}
    .fld label{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px}
    .fld input,.fld textarea{padding:12px 14px;border-radius:12px;border:1px solid #d0d5dd;background:#fff;font-family:inherit;font-size:14px;outline:none}
    .fld input:focus,.fld textarea:focus{border-color:#b7df9f; box-shadow:0 0 0 3px rgba(109,189,69,.18)}
    .fld textarea{min-height:110px;resize:vertical}
    .note{color:var(--muted);font-size:12px;margin-top:6px;grid-column:1 / -1}
    .modal .ft{padding:14px 20px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;background:#fff;border-bottom-left-radius:18px;border-bottom-right-radius:18px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-weight:700;background:#eef2f6;border:1px solid #dde3ea;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">

    <header class="bar">
      <a class="back" href="../index.html">‚Üê Back to index</a>
      <div class="brand">
        <img class="logo" id="logo" alt="Parcsafe">
      </div>
    </header>

    <h1 class="title">
      Drawer details
      <span class="drawer-code">C2_CP2_0_I</span>
    </h1>

    <div class="meta">
      <div id="product-name"><strong>Product Name:</strong> loading...</div>
      <div class="codeWrap">
        <div id="product-code"><strong>Product Code:</strong> loading...</div>
        <button class="btn secondary" id="editInfoBtn">‚úèÔ∏è Edit Product Info</button>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <h3>Drawer Photo</h3>
        <div class="imgwrap">
          <img id="drawerImg" src="../images/C2_CP2_0_I.jpg" alt="Drawer image C2_CP2_0_I" onerror="this.onerror=null; this.src='../../images/C2_CP2_0_I.jpg';" />
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn" id="uploadPhotoBtn">üñºÔ∏è Update Drawer Photo</button>
          <button class="btn ghost" id="refreshImgBtn">Refresh</button>
          <span class="note">The new image will be renamed to <strong>C2_CP2_0_I.jpg</strong> automatically.</span>
        </div>
        <input type="file" id="fileInput" accept="image/png,image/jpeg" style="display:none" />
      </div>

      <div class="card">
        <h3>Cabinet Highlight</h3>
        <div class="imgwrap">
          <img id="cabImg" src="../images/C2_CP2_cabinet_C2_CP2_0_I.png" alt="Cabinet highlight" onerror="this.onerror=null; this.src='../../images/C2_CP2_cabinet_C2_CP2_0_I.png';" />
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <h3>Description</h3>
      <div id="description-text" style="line-height:1.6">loading...</div>
    </div>

    <div class="stock-display" id="stock-display">Loading stock...</div>

    <div class="stock-ui" id="stockUI">
      <div class="row">
        <span class="pill">Current: <strong id="curQty">‚Äì</strong></span>
        <span class="pill">Change: <strong id="delta">0</strong></span>
        <span class="pill">New: <strong id="newQty">‚Äì</strong></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="minusBtn">‚àí1</button>
        <button id="plusBtn">+1</button>
        <label>Exact: <input id="exactInput" type="number" min="0" step="1" /></label>
        <button class="secondary" id="resetBtn">Reset</button>
        <button class="save" id="saveBtn">Save</button>
      </div>
      <div class="warn" id="minWarn">LOW STOCK ‚Äî minimum 10</div>
    </div>

    <div id="toast"></div>
  </div>

  <!-- Improved Modal -->
  <dialog class="modal" id="editModal">
    <form method="dialog" id="editForm">
      <div class="hd">
        <strong>Edit product info</strong>
        <button class="close-x" value="cancel" aria-label="Close">‚úï</button>
      </div>
      <div class="bd">
        <div class="fld">
          <label for="fldName">Product Name</label>
          <input id="fldName" type="text" required />
        </div>
        <div class="fld">
          <label for="fldCode">Product Code</label>
          <input id="fldCode" type="text" required />
        </div>
        <div class="fld fld--wide">
          <label for="fldDesc">Description</label>
          <textarea id="fldDesc" required></textarea>
        </div>
        <div class="note">Tip: press <span class="kbd">Esc</span> to close.</div>
      </div>
      <div class="ft">
        <button class="btn ghost" value="cancel">Cancel</button>
        <button class="btn" id="saveInfoBtn" value="default">Save changes</button>
      </div>
    </form>
  </dialog>

  <script>
    const drawerCode = "C2_CP2_0_I";
    const STOCK_API = "https://stock-api.ramonpertinez.workers.dev/stock/item";
    const UPLOAD_ENDPOINT = "https://stock-api.ramonpertinez.workers.dev/upload-image";
    const UPDATE_INFO_ENDPOINT = "https://stock-api.ramonpertinez.workers.dev/update-item-info";

    // ===== Robust logo loader (tries multiple paths & encodings) =====
    (function loadLogo(){
      const logo = document.getElementById('logo');
      const candidates = [
        "../PARCsafe-%5B369%5D-BP-2022.png",
        "../../PARCsafe-%5B369%5D-BP-2022.png",
        "../../../PARCsafe-%5B369%5D-BP-2022.png",
        "../PARCsafe-[369]-BP-2022.png",
        "../../PARCsafe-[369]-BP-2022.png",
        "../../../PARCsafe-[369]-BP-2022.png"
      ];
      let i = 0;
      const tryNext = () => {
        if(i >= candidates.length){ logo.remove(); return; }
        logo.src = candidates[i++];
      };
      logo.onerror = tryNext;
      tryNext();
    })();

    const toast = document.getElementById("toast");
    function showToast(msg, color="#198754"){
      toast.textContent = msg;
      toast.style.backgroundColor = color;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 2600);
    }

    async function loadCSVFromCandidates(){
      const candidates = ["../stock.csv", "../../stock.csv", "../../../stock.csv", "./stock.csv"];
      for (const url of candidates){
        try{
          const res = await fetch(url + "?t=" + Date.now());
          if(res.ok){
            const txt = await res.text();
            if (txt && txt.includes("drawerCode")) return txt;
          }
        }catch(_e){}
      }
      throw new Error("stock.csv not found via relative paths");
    }

    loadCSVFromCandidates()
      .then(csv => {
        const rows = csv.trim().split("\\n");
        const headers = rows[0].split(",");
        const data = rows.slice(1).map(r => {
          const vals = r.split(",");
          return headers.reduce((o, h, i) => { o[h.trim()] = vals[i] ? vals[i].trim() : ""; return o; }, {});
        });
        const match = data.find(r => (r.drawerCode || "").trim() === drawerCode);
        if (!match) throw new Error("Drawer not found");

        document.getElementById("product-name").innerHTML = `<strong>Product Name:</strong> ${match.productName || ""}`;
        document.getElementById("product-code").innerHTML = `<strong>Product Code:</strong> ${match.productCode || ""}`;
        document.getElementById("description-text").textContent = match.description || "";

        const MIN_STOCK = parseInt(match.minStock || "10", 10);
        document.getElementById("stock-display").innerText = "üì¶ STOCK: " + (match.stockQty || "0");
        document.getElementById("minWarn").textContent = `LOW STOCK ‚Äî minimum ${MIN_STOCK}`;

        initStockUI(parseInt(match.stockQty || "0", 10), MIN_STOCK);

        document.getElementById("fldName").value = match.productName || "";
        document.getElementById("fldCode").value = match.productCode || "";
        document.getElementById("fldDesc").value = match.description || "";
      })
      .catch(e => {
        document.getElementById("stock-display").innerText = "‚ùå Error: " + e.message;
      });

    function initStockUI(initialQty, MIN_STOCK = 10) {
      const curEl = document.getElementById('curQty');
      const deltaEl = document.getElementById('delta');
      const newEl = document.getElementById('newQty');
      const minus = document.getElementById('minusBtn');
      const plus = document.getElementById('plusBtn');
      const exact = document.getElementById('exactInput');
      const reset = document.getElementById('resetBtn');
      const save = document.getElementById('saveBtn');
      const warn = document.getElementById('minWarn');

      let cur = initialQty, delta = 0;

      function refresh(){
        curEl.textContent = cur;
        deltaEl.textContent = delta > 0 ? '+' + delta : delta;
        const nv = cur + delta;
        newEl.textContent = nv;
        exact.value = nv;
        document.getElementById('stock-display').textContent = 'üì¶ STOCK: ' + nv;
        if (nv < MIN_STOCK) { warn.classList.add('pulse'); warn.style.display='block'; }
        else { warn.classList.remove('pulse'); warn.style.display='none'; }
      }

      minus.addEventListener('click', ()=>{ delta -= 1; refresh(); });
      plus.addEventListener('click', ()=>{ delta += 1; refresh(); });
      exact.addEventListener('input', ()=>{ const v=parseInt(exact.value,10); if(!isNaN(v)){ delta=v-cur; refresh(); }});
      reset.addEventListener('click', ()=>{ delta=0; refresh(); });

      save.addEventListener('click', async ()=> {
        const newVal = cur + delta;
        if(!confirm(`Are you sure you want to update the stock to ${newVal}?`)) return;
        try{
          const r = await fetch(STOCK_API, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ drawerCode, newQty: newVal })
          });
          if (!r.ok) throw new Error(await r.text());
          cur = newVal; delta = 0; refresh();
          showToast('‚úîÔ∏è Stock successfully updated');
        }catch(e){
          console.error(e);
          showToast('‚ùå Error updating stock', '#b3261e');
        }
      });

      refresh();
    }

    // Image upload
    const uploadBtn = document.getElementById('uploadPhotoBtn');
    const refreshImgBtn = document.getElementById('refreshImgBtn');
    const fileInput = document.getElementById('fileInput');

    uploadBtn.addEventListener('click', ()=> fileInput.click());
    refreshImgBtn.addEventListener('click', ()=> {
      const el = document.getElementById('drawerImg');
      el.src = `../images/${drawerCode}.jpg?t=${Date.now()}`;
    });

    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      if(!/image\/(jpeg|png)/.test(file.type)) return showToast('Only JPG/PNG allowed', '#b3261e');
      if(file.size > 8*1024*1024) return showToast('Max 8MB image', '#b3261e');

      const fd = new FormData();
      fd.append('image', file);
      fd.append('drawerCode', drawerCode);

      try{
        const r = await fetch("https://stock-api.ramonpertinez.workers.dev/upload-image", { method:'POST', body: fd });
        if(!r.ok) throw new Error(await r.text());
        showToast('‚úîÔ∏è Image updated successfully');
        const el = document.getElementById('drawerImg');
        el.src = `../images/${drawerCode}.jpg?t=${Date.now()}`;
      }catch(err){
        console.error(err);
        showToast('‚ùå Error uploading image', '#b3261e');
      }finally{
        fileInput.value = '';
      }
    });

    // Modal interactions
    const editBtn = document.getElementById('editInfoBtn');
    const modal = document.getElementById('editModal');
    const saveInfoBtn = document.getElementById('saveInfoBtn');
    const fldName = document.getElementById('fldName');
    const fldCode = document.getElementById('fldCode');
    const fldDesc = document.getElementById('fldDesc');

    editBtn.addEventListener('click', ()=> modal.showModal());
    modal.addEventListener('click', (e)=>{
      const rect = modal.getBoundingClientRect();
      const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inside) modal.close(); // click outside to close
    });

    saveInfoBtn.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const name = fldName.value.trim();
      const code = fldCode.value.trim();
      const desc = fldDesc.value.trim();
      if(!name || !code || !desc){ showToast('Please fill all fields', '#b3261e'); return; }

      try{
        const r = await fetch(UPDATE_INFO_ENDPOINT, {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ drawerCode, productName:name, productCode:code, description:desc })
        });
        if(!r.ok) throw new Error(await r.text());
        document.getElementById("product-name").innerHTML = `<strong>Product Name:</strong> ${name}`;
        document.getElementById("product-code").innerHTML = `<strong>Product Code:</strong> ${code}`;
        document.getElementById("description-text").textContent = desc;
        modal.close();
        showToast('‚úîÔ∏è Product info updated');
      }catch(err){
        console.error(err);
        showToast('‚ùå Error updating info', '#b3261e');
      }
    });
  </script>
</body>
</html>
