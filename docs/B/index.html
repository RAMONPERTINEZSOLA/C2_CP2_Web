<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rack B ‚Äî Parcsafe Dynamic Multi-Drawer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root{
      --green:#6dbd45; --green-2:#5aa83a; --ink:#222; --muted:#667085;
      --bg:#f5f7f8; --card:#ffffff; --line:#e6e8eb; --danger:#b3261e;
      --brand-shadow:0 6px 24px rgba(109,189,69,.18); --radius:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);color:var(--ink);
    }

    .container{max-width:1260px;margin:40px auto;padding:0 20px;}

    header.bar{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;margin-bottom:24px;flex-wrap:wrap;
    }
    .back{
      display:inline-flex;align-items:center;gap:8px;padding:10px 14px;
      border-radius:999px;border:1px solid var(--line);background:var(--card);
      text-decoration:none;color:var(--ink);font-weight:600;
    }
    .logo{height:64px;object-fit:contain}
    .brand{display:flex;align-items:center;gap:10px}

    h1.title{
      font-size:28px;margin:10px 0 6px 0;
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .badge{
      font-size:12px;color:#475467;background:#eef4ff;border:1px solid #d6e4ff;
      padding:4px 8px;border-radius:999px;font-weight:700;letter-spacing:.3px;
    }

    .meta-global{
      font-size:14px;color:var(--muted);margin-bottom:26px;
      line-height:1.5;
    }

    /* ======== GROUP BLOCKS ======== */
    .group-block{
      margin-bottom:40px;
      padding:20px;
      border-radius:18px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--brand-shadow);
    }

    .group-title{
      font-size:20px;
      font-weight:700;
      margin-bottom:12px;
    }

    .variant-controls{
      margin:15px 0 25px 0;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .variant-controls .note{
      font-size:13px;
      color:var(--muted);
      margin-left:auto;
    }

    /* ======== Drawer Block ======== */
    .drawer-block{
      background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);padding:16px;
      box-shadow:var(--brand-shadow);
      display:flex;flex-direction:column;gap:12px;
      margin-bottom:20px;
    }

    /* Collapsed / empty behaviour */
    .drawer-block.collapsed .drawer-body{
      display:none;
    }
    .drawer-toggle{
      border:none;background:transparent;padding:4px 6px;
      border-radius:999px;cursor:pointer;font-size:14px;
    }
    .drawer-block.empty .drawer-title-small{
      color:var(--muted);font-style:italic;
    }
    .drawer-block.empty [data-role="product-code-label"]{
      color:var(--muted);
    }

    .drawer-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;
    }
    .drawer-header-left{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .drawer-code-pill{
      font-size:12px;color:#475467;background:#eef4ff;border:1px solid #d6e4ff;
      padding:4px 8px;border-radius:999px;font-weight:700;letter-spacing:.3px;
    }
    .drawer-title-small{
      font-size:14px;font-weight:600;
    }

    .drawer-header-actions{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }

    .btn{
      border:none;border-radius:12px;padding:6px 10px;
      font-weight:600;cursor:pointer;font-size:12px;
      display:inline-flex;align-items:center;gap:6px;
      background:var(--green);color:#fff;box-shadow:var(--brand-shadow);
    }
    .btn:hover{background:var(--green-2);}
    .btn.secondary{background:#98a2b3;box-shadow:none;}
    .btn.ghost{
      background:#fff;color:var(--ink);border:1px solid var(--line);
      box-shadow:none;
    }

    .cards{
      display:grid;grid-template-columns:1fr;gap:16px;
    }

    .card{background:var(--card);border-radius:var(--radius);}
    .card h3{margin:0 0 8px 0;font-size:14px;}
    .card-inner{padding:10px 0;}

    .imgwrap{
      border:1px dashed #cdd4d9;background:#fafafa;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      min-height:180px;overflow:hidden;
    }
    .imgwrap img{max-width:100%;height:auto;display:block;}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .note{font-size:11px;color:var(--muted);}

    .description-box{
      border-radius:var(--radius);border:1px solid var(--line);
      padding:10px;margin-top:4px;font-size:13px;line-height:1.5;
      min-height:60px;background:#fafafa;
    }

    .stock-display{
      font-size:22px;font-weight:700;margin-top:8px;
    }

    .stock-ui{
      margin-top:8px;padding:10px;border:1px solid var(--line);
      border-radius:var(--radius);background:var(--card);
    }
    .stock-ui .pill{
      padding:6px 10px;border-radius:999px;background:#eef2f6;
      border:1px solid #dde3ea;font-variant-numeric:tabular-nums;
      font-size:12px;
    }
    .stock-ui input[type="number"]{
      width:90px;padding:6px 8px;border:1px solid #c9cfd6;border-radius:8px;
      font-size:12px;
    }
    .stock-ui .warn{
      margin-top:8px;padding:8px 10px;border-radius:10px;background:#ffe3e3;
      color:var(--danger);font-weight:700;display:none;border:1px solid #f3b5b5;
      font-size:12px;
    }
    .stock-ui .warn.pulse{
      display:block;animation:pulse 1s infinite;
    }
    .stock-ui .warn.pulse::before{
      content:"‚ùó‚ùó";margin-right:8px;display:inline-block;animation:wiggle .8s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(220,53,69,.35)}
      70%{box-shadow:0 0 0 10px rgba(220,53,69,0)}
      100%{box-shadow:0 0 0 0 rgba(220,53,69,0)}
    }
    @keyframes wiggle{
      0%{transform:translateY(0)}
      50%{transform:translateY(-2px)}
      100%{transform:translateY(0)}
    }

    #toast{
      position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
      background-color:#198754;color:white;padding:10px 20px;border-radius:10px;
      font-weight:700;display:none;animation:fade 3s ease forwards;z-index:1000;
    }
    @keyframes fade{
      0%{opacity:0;transform:translate(-50%,10px)}
      10%{opacity:1;transform:translate(-50%,0)}
      90%{opacity:1;transform:translate(-50%,0)}
      100%{opacity:0;transform:translate(-50%,10px)}
    }

    /* POST-SAVE BANNER */
    #postSaveBanner{
      position:fixed;inset:auto 20px 20px 20px;
      background:#0f1b2f;color:#e8f3ff;border:1px solid #cfe4ff33;
      border-radius:14px;padding:10px 12px;box-shadow:0 12px 40px rgba(0,0,0,.35);
      display:none;z-index:2000;font-size:13px;
    }
    #postSaveBanner .counter{
      font-variant-numeric:tabular-nums;font-weight:700;
    }
    #postSaveBanner button{
      background:#ffffff;color:#0f1b2f;border:1px solid #cfe4ff66;
      border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer;font-size:12px;
    }

    /* ====== MODALS ====== */
    dialog.modal{
      border:none;border-radius:22px;padding:0;max-width:520px;width:96%;
      box-shadow:0 24px 80px rgba(16,24,40,.35);
      background:linear-gradient(180deg,#fff,#f9fbfa);
    }
    dialog.modal::backdrop{
      background:rgba(10,12,14,.45);backdrop-filter:blur(3px)
    }
    .modal .hd{
      padding:18px 20px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      background:#f0f7ec;
    }
    .modal .hd strong{font-size:16px}
    .close-x{
      background:transparent;border:none;font-size:22px;cursor:pointer;line-height:1;
    }
    .modal .bd{padding:18px 20px;display:flex;flex-direction:column;gap:12px;}
    .fld{display:flex;flex-direction:column;gap:6px}
    .fld label{
      font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;
      letter-spacing:.4px;
    }
    .fld input,.fld textarea,.fld select{
      padding:10px 12px;border-radius:12px;border:1px solid #d0d5dd;
      background:#fff;font-family:inherit;font-size:14px;outline:none;
    }
    .fld textarea{min-height:90px;resize:vertical;}
    .fld input:focus,.fld textarea:focus,.fld select:focus{
      border-color:#b7df9f;box-shadow:0 0 0 3px rgba(109,189,69,.18)
    }
    .modal .ft{
      padding:14px 20px;border-top:1px solid var(--line);
      display:flex;gap:10px;justify-content:flex-end;background:#fff;
      border-bottom-left-radius:22px;border-bottom-right-radius:22px;
    }

    /* QR canvas */
    #qrCanvas{
      max-width:260px;width:100%;height:auto;
      border:1px dashed #d0d5d0;border-radius:12px;background:#fff;
    }
  </style>

  <!-- QR + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script type="module">
    import * as m from 'https://cdn.jsdelivr.net/npm/nayuki-qr-code-generator@1.8.0/index.js';
    const lib = (m && m.QrCode) ? m : (m && m.default && m.default.QrCode) ? m.default : m;
    window.qrcodegen = lib;
  </script>
</head>
<body>
  <div class="container">

    <!-- HEADER -->
    <header class="bar">
      <a class="back" href="../index.html">‚Üê Back to index</a>
      <div class="brand">
        <img class="logo" id="logo" alt="Parcsafe">
      </div>
    </header>

    <h1 class="title">
      Rack B ‚Äî Dynamic multi-drawer view
      <span class="badge">B1 ¬∑ B2 ¬∑ B3 ¬∑ B4 (auto-variants)</span>
    </h1>

    <p class="meta-global">
      This rack automatically generates all existing drawers for the groups
      <strong>B1</strong>, <strong>B2</strong>, <strong>B3</strong> and <strong>B4</strong>.
      <br>
      It detects variants <strong>A ‚Üí F</strong> (or more if they exist), builds the full drawer view,
      and lets you add or remove variants at any time.
      <br><br>
      All information is synchronised with <code>stock.csv</code> and the official Parcsafe backend.
    </p>

    <!-- ======================= -->
    <!-- üî• GROUP CONTAINERS üî•  -->
    <!-- ======================= -->

    <!-- B1 -->
    <section class="group-block" data-group="B1">
      <div class="group-title">Group B1</div>

      <div class="variant-controls" data-variant-base="B1">
        <button class="btn" data-role="add-variant">‚ûï Add variant</button>
        <div class="note" data-role="variant-list">Variants: loading‚Ä¶</div>
      </div>

      <!-- Drawer blocks will be injected here -->
      <div class="drawer-container" data-container="B1"></div>
    </section>

    <!-- B2 -->
    <section class="group-block" data-group="B2">
      <div class="group-title">Group B2</div>

      <div class="variant-controls" data-variant-base="B2">
        <button class="btn" data-role="add-variant">‚ûï Add variant</button>
        <div class="note" data-role="variant-list">Variants: loading‚Ä¶</div>
      </div>

      <div class="drawer-container" data-container="B2"></div>
    </section>

    <!-- B3 -->
    <section class="group-block" data-group="B3">
      <div class="group-title">Group B3</div>

      <div class="variant-controls" data-variant-base="B3">
        <button class="btn" data-role="add-variant">‚ûï Add variant</button>
        <div class="note" data-role="variant-list">Variants: loading‚Ä¶</div>
      </div>

      <div class="drawer-container" data-container="B3"></div>
    </section>

    <!-- B4 -->
    <section class="group-block" data-group="B4">
      <div class="group-title">Group B4</div>

      <div class="variant-controls" data-variant-base="B4">
        <button class="btn" data-role="add-variant">‚ûï Add variant</button>
        <div class="note" data-role="variant-list">Variants: loading‚Ä¶</div>
      </div>

      <div class="drawer-container" data-container="B4"></div>
    </section>

    <!-- TOAST -->
    <div id="toast"></div>

  </div> <!-- /container -->


  <!-- POST-SAVE BANNER -->
  <div id="postSaveBanner" role="status" aria-live="polite">
    <div class="row">
      <div>
        <strong>Change saved.</strong>
        Please wait about <span class="counter" id="psbCounter">60</span>s
        and then refresh the page to see it everywhere.
      </div>
      <div class="row">
        <button id="psbRefreshBtn" type="button">Refresh now</button>
      </div>
    </div>
  </div>

  <!-- ===================== -->
  <!--    EDIT INFO MODAL    -->
  <!-- ===================== -->

  <dialog class="modal" id="editModal">
    <form method="dialog" id="editForm">
      <div class="hd">
        <strong>Edit product info</strong>
        <button class="close-x" value="cancel" aria-label="Close" type="button">‚úï</button>
      </div>
      <div class="bd">
        <div class="fld">
          <label for="fldName">Product name</label>
          <input id="fldName" type="text" />
        </div>
        <div class="fld">
          <label for="fldCode">Product code</label>
          <input id="fldCode" type="text" />
        </div>
        <div class="fld">
          <label for="fldDesc">Description</label>
          <textarea id="fldDesc"></textarea>
        </div>
        <div class="fld">
          <label for="fldMinStock">Minimum stock (alert threshold)</label>
          <input id="fldMinStock" type="number" min="0" step="1" />
        </div>
        <div class="fld">
          <label for="fldMode">Update mode</label>
          <select id="fldMode">
            <option value="NEW">Create / overwrite as NEW product</option>
            <option value="EXISTING">Link to EXISTING product definition</option>
            <option value="DESC_ONLY">Update DESCRIPTION only</option>
          </select>
        </div>
        <p class="note">
          ‚Ä¢ <strong>NEW</strong>: use this when you are defining a brand-new product name.  
          ‚Ä¢ <strong>EXISTING</strong>: reuse an existing product definition if the name already exists in other drawers.  
          ‚Ä¢ <strong>DESCRIPTION ONLY</strong>: keep name and code, only update the description text and minimum stock.
        </p>
      </div>
      <div class="ft">
        <button class="btn ghost" value="cancel" type="button">Cancel</button>
        <button class="btn" id="saveInfoBtn" type="button">Save changes</button>
      </div>
    </form>
  </dialog>

  <!-- ===================== -->
  <!--      QR MODAL         -->
  <!-- ===================== -->

  <dialog class="modal" id="qrModal">
    <div class="hd">
      <strong>Product QR</strong>
      <button class="close-x" value="cancel" aria-label="Close" id="qrClose" type="button">‚úï</button>
    </div>
    <div class="bd" style="align-items:center;">
      <canvas id="qrCanvas" width="1024" height="1024"></canvas>
      <div class="note" id="qrUrlNote"
           style="text-align:center;word-break:break-all;margin-top:10px;"></div>
    </div>
    <div class="ft">
      <button class="btn ghost" id="copyLinkBtn" type="button">Copy URL</button>
      <button class="btn ghost" id="dlPngBtn" type="button">Download PNG</button>
      <button class="btn" id="dlPdfBtn" type="button">Download PDF</button>
    </div>
  </dialog>
  <!-- ===================== -->
  <!--     SCRIPT PART       -->
  <!-- ===================== -->
  <script>
  /* ==============================
        CONFIG
  =============================== */
  const GROUPS = ["B1", "B2", "B3", "B4"];

  const STOCK_API             = "https://stock-api.ramonpertinez.workers.dev/stock/item";
  const UPLOAD_ENDPOINT       = "https://stock-api.ramonpertinez.workers.dev/upload-image";
  const UPDATE_INFO_ENDPOINT  = "https://stock-api.ramonpertinez.workers.dev/update-item-info";
  const STOCK_FILE_ENDPOINT   = "https://stock-api.ramonpertinez.workers.dev/stock/file";

  const GET_VARIANTS_ENDPOINT   = "https://stock-api.ramonpertinez.workers.dev/get-variants?base=";
  const CREATE_VARIANT_ENDPOINT = "https://stock-api.ramonpertinez.workers.dev/create-variant";
  const RESET_DRAWER_ENDPOINT   = "https://stock-api.ramonpertinez.workers.dev/reset-drawer";

  // Global CSV data (kept in sync when we edit)
  window.ALL_DATA = [];

  /* ==============================
        TOAST
  =============================== */
  const toast = document.getElementById("toast");
  function showToast(msg, color = "#198754") {
    toast.textContent = msg;
    toast.style.backgroundColor = color;
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 2600);
  }

  /* ==============================
        POST-SAVE BANNER
  =============================== */
  const psb          = document.getElementById("postSaveBanner");
  const psbCounter   = document.getElementById("psbCounter");
  const psbRefreshBtn = document.getElementById("psbRefreshBtn");

  psbRefreshBtn.addEventListener("click", () => location.reload());

  let psbTimer = null;
  function showPostSaveBanner(seconds = 60) {
    clearInterval(psbTimer);
    psbCounter.textContent = String(seconds);
    psb.style.display = "block";
    psbTimer = setInterval(() => {
      let v = parseInt(psbCounter.textContent || "0", 10);
      v = Math.max(0, v - 1);
      psbCounter.textContent = String(v);
      if (v <= 0) clearInterval(psbTimer);
    }, 1000);
  }

  /* ==============================
        LOAD LOGO
  =============================== */
  (function loadLogo() {
    const logo = document.getElementById("logo");
    if (!logo) return;
    const candidates = [
      "../../PARCsafe-[369]-BP-2022.png",
      "../PARCsafe-[369]-BP-2022.png",
      "../../../PARCsafe-[369]-BP-2022.png",
      "../../parcsafe-logo.png",
      "../parcsafe-logo.png",
      "../../../parcsafe-logo.png",
    ];
    let i = 0;
    const tryNext = () => {
      if (i >= candidates.length) {
        logo.remove();
        return;
      }
      logo.onerror = () => {
        i++;
        tryNext();
      };
      logo.src = candidates[i++];
    };
    tryNext();
  })();

  /* ==============================
        CSV LOADING
  =============================== */
  function parseCSV(txt) {
    const rows = txt.trim().split(/\r?\n/);
    const headers = rows[0].split(",").map((h) => h.trim());
    return rows.slice(1).map((r) => {
      const vals = r.split(",");
      return headers.reduce((o, h, i) => {
        o[h] = vals[i] ? vals[i].trim() : "";
        return o;
      }, {});
    });
  }

  async function loadCSV() {
    const candidates = [
      "../../stock.csv",
      "../stock.csv",
      "../../../stock.csv",
      "./stock.csv",
      "/docs/stock.csv",
      window.location.origin + "/docs/stock.csv",
    ];
    for (const url of candidates) {
      try {
        const res = await fetch(url + "?t=" + Date.now());
        if (res.ok) {
          const txt = await res.text();
          if (txt.includes("drawerCode")) return parseCSV(txt);
        }
      } catch (_) {}
    }
    throw new Error("stock.csv not found");
  }

  function buildCsvFromAllData() {
    const header = [
      "drawerCode",
      "stockQty",
      "productName",
      "productCode",
      "description",
      "minStock",
    ];
    const lines = [header.join(",")];

    for (const row of window.ALL_DATA) {
      const vals = header.map((h) => {
        const v = row[h] ?? "";
        return String(v)
          .replace(/[\r\n]+/g, " ")
          .replace(/,/g, "¬∑");
      });
      lines.push(vals.join(","));
    }
    return lines.join("\n");
  }

  // ===== EXISTING PRODUCTS HELPERS (like Rack A) =====
  function normalizeName(s) {
    return String(s || "")
      .normalize("NFKC")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
  }

  // Unique product names by NAME, with counter
  function uniqueProductNamesFromData(data) {
    const map = new Map(); // key normalised -> { display, n }
    for (const r of data || []) {
      const raw = (r.productName || "").trim();
      if (!raw) continue;
      const key = normalizeName(raw);
      const prev = map.get(key) || { display: raw, n: 0 };
      prev.n += 1;
      map.set(key, prev);
    }
    return [...map.values()].sort((a, b) => b.n - a.n);
  }

  // Given a name, pick most frequent code / description
  function canonicalByProductName(name) {
    const key = normalizeName(name);
    const rows = (window.ALL_DATA || []).filter(
      (r) => normalizeName(r.productName || "") === key
    );
    if (!rows.length) {
      return {
        productName: name.trim(),
        productCode: "",
        description: "",
      };
    }
    const codes = rows.map((r) => r.productCode || "");
    const descs = rows.map((r) => r.description || "");

    function modeNonEmpty(arr) {
      const m = new Map();
      for (const v of arr) {
        const s = String(v || "").trim();
        if (!s) continue;
        m.set(s, (m.get(s) || 0) + 1);
      }
      let best = "";
      let bestN = 0;
      for (const [val, n] of m.entries()) {
        if (n > bestN) {
          best = val;
          bestN = n;
        }
      }
      return best;
    }

    return {
      productName: name.trim(),
      productCode: modeNonEmpty(codes) || "",
      description: modeNonEmpty(descs) || "",
    };
  }

  async function updateMinStockForDrawer(drawerCode, newMin) {
    const rows = window.ALL_DATA || [];
    let found = false;
    for (const row of rows) {
      if ((row.drawerCode || "").trim() === drawerCode) {
        row.minStock = String(newMin);
        found = true;
        break;
      }
    }
    if (!found) return; // nothing to do

    const csvText = buildCsvFromAllData();

    const res = await fetch(STOCK_FILE_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: csvText,
    });
    const j = await res.json().catch(() => ({}));
    if (!res.ok || !j.ok) {
      throw new Error(j.error || "Failed to update minStock");
    }
  }

  /* ==============================
        VARIANT MANAGEMENT (worker)
  =============================== */
  async function loadVariants(base) {
    const r = await fetch(GET_VARIANTS_ENDPOINT + base);
    const j = await r.json();
    if (!r.ok || !j.ok) throw new Error("Failed to load variants");
    return j.variants;
  }

  async function addVariant(base) {
    const r = await fetch(CREATE_VARIANT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ base }),
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok || !j.ok) throw new Error(j.error || "Failed to create variant");
    return j.drawerCode; // e.g. B1_B
  }

  /* ==============================
        QR HELPERS
  =============================== */
  function hrefFromDrawer(code) {
    const up = String(code || "").toUpperCase();
    if (/^[AB]\d+_/.test(up)) {
      const letter = up[0]; // A or B
      return `${letter}/fitxes/${code}.html`;
    }
    return `fitxes/${code}.html`;
  }

  function buildQrUrl(drawerCode) {
    return (
      "https://ramonpertinezsola.github.io/C2_CP2_Web/" +
      hrefFromDrawer(drawerCode)
    );
  }

  let qrLogoPromise;
  const LOGO_CANDIDATES = [
    "../../parcsafe-logo.png",
    "../parcsafe-logo.png",
    "../../../parcsafe-logo.png",
  ];
  function loadQrLogo() {
    if (qrLogoPromise) return qrLogoPromise;
    qrLogoPromise = new Promise((resolve) => {
      let i = 0;
      const tryNext = () => {
        if (i >= LOGO_CANDIDATES.length) return resolve(null);
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => {
          i++;
          tryNext();
        };
        img.src = LOGO_CANDIDATES[i];
      };
      tryNext();
    });
    return qrLogoPromise;
  }

  async function ensureQrLib(timeout = 1000) {
    const t0 = performance.now();
    while (!(window.qrcodegen && window.qrcodegen.QrCode)) {
      if (performance.now() - t0 > timeout)
        throw new Error("QR library not ready");
      await new Promise((r) => setTimeout(r, 20));
    }
  }

  async function drawQR(canvas, url) {
    const size = 1024;
    const ctx = canvas.getContext("2d");
    canvas.width = size;
    canvas.height = size;
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(0, 0, size, size);

    const ecc = window.qrcodegen.QrCode.Ecc.HIGH || window.qrcodegen.QrCode.Ecc.H;
    const qr = window.qrcodegen.QrCode.encodeText(url, ecc);
    const modules = qr.size;
    const border = 2;
    const ppm = Math.floor(size / (modules + border * 2));
    const qrPix = ppm * (modules + border * 2);
    const offset = Math.floor((size - qrPix) / 2);

    ctx.fillStyle = "#000000";
    for (let y = 0; y < modules; y++) {
      for (let x = 0; x < modules; x++) {
        if (qr.getModule(x, y)) {
          const px = offset + (x + border) * ppm;
          const py = offset + (y + border) * ppm;
          ctx.fillRect(px, py, ppm, ppm);
        }
      }
    }

    const logoImg = await loadQrLogo();
    if (logoImg) {
      const logoBox = Math.floor(size * 0.22);
      const cx = size / 2;
      const cy = size / 2;
      const r = Math.floor(logoBox / 2) + 14;

      ctx.save();
      ctx.fillStyle = "#FFFFFF";
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      const pad = 18;
      const w = logoBox - pad * 2;
      const h = logoBox - pad * 2;
      const aspect = logoImg.width / logoImg.height;
      let drawW = w;
      let drawH = w / aspect;
      if (drawH > h) {
        drawH = h;
        drawW = h * aspect;
      }
      ctx.drawImage(logoImg, cx - drawW / 2, cy - drawH / 2, drawW, drawH);
    }
  }

  /* ==============================
        EDIT INFO MODAL
  =============================== */
  const editModal   = document.getElementById("editModal");
  const fldName     = document.getElementById("fldName");
  const fldCode     = document.getElementById("fldCode");
  const fldDesc     = document.getElementById("fldDesc");
  const fldMinStock = document.getElementById("fldMinStock");
  const fldMode     = document.getElementById("fldMode");
  const saveInfoBtn = document.getElementById("saveInfoBtn");

  let currentInfoDrawer = null;

  // Existing picker (created dynamically)
  let existingPickerWrap = null;
  let existingSelect = null;
  let existingPickerInit = false;

  function ensureExistingPicker() {
    if (existingPickerInit) return;
    existingPickerInit = true;

    const bd = editModal.querySelector(".bd");
    const modeFld = fldMode.closest(".fld");

    existingPickerWrap = document.createElement("div");
    existingPickerWrap.className = "fld";
    existingPickerWrap.id = "existingPickerWrap";
    existingPickerWrap.style.display = "none";
    existingPickerWrap.innerHTML = `
      <label for="fldExistingSelect">Existing product (by name)</label>
      <select id="fldExistingSelect">
        <option value="">‚Äî Select an existing product ‚Äî</option>
      </select>
      <p class="note">
        When you link to an existing product, the <strong>name, code and description</strong>
        will be reused from the canonical definition in <code>stock.csv</code>.
      </p>
    `;

    // Insert just after "Update mode"
    bd.insertBefore(existingPickerWrap, modeFld.nextSibling);

    existingSelect = existingPickerWrap.querySelector("#fldExistingSelect");
    existingSelect.addEventListener("change", () => {
      const val = (existingSelect.value || "").trim();
      if (!val) return;
      const canon = canonicalByProductName(val);
      fldName.value = canon.productName || "";
      fldCode.value = canon.productCode || "";
      fldDesc.value = canon.description || "";
    });
  }

  function populateExistingOptions(currentName) {
    ensureExistingPicker();
    if (!existingSelect) return;

    const items = uniqueProductNamesFromData(window.ALL_DATA || []);
    existingSelect.innerHTML =
      '<option value="">‚Äî Select an existing product ‚Äî</option>';

    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = it.display;
      opt.textContent = `${it.display} (${it.n})`;
      existingSelect.appendChild(opt);
    }

    // Try to preselect current drawer name
    if (currentName) {
      const targetKey = normalizeName(currentName);
      for (const opt of existingSelect.options) {
        if (normalizeName(opt.value) === targetKey) {
          existingSelect.value = opt.value;
          break;
        }
      }
    }
  }

  function openEditModalForDrawer(drawerCode, row) {
    currentInfoDrawer = drawerCode;
    const name = row?.productName || "";
    fldName.value = name;
    fldCode.value = row?.productCode || "";
    fldDesc.value = row?.description || "";
    fldMinStock.value = row?.minStock || "";
    fldMode.value = "NEW"; // default mode

    ensureExistingPicker();
    if (existingPickerWrap) existingPickerWrap.style.display = "none";

    try {
      editModal.showModal();
    } catch {
      editModal.setAttribute("open", "");
    }

    // If user switches to EXISTING, show selector
    fldMode.onchange = () => {
      const mode = (fldMode.value || "NEW").toUpperCase();
      if (mode === "EXISTING") {
        populateExistingOptions(name);
        if (existingPickerWrap) existingPickerWrap.style.display = "";
      } else if (existingPickerWrap) {
        existingPickerWrap.style.display = "none";
      }
    };
  }

  // Close handlers
  document
    .querySelector("#editModal .close-x")
    .addEventListener("click", () => editModal.close());
  document
    .querySelector("#editModal .btn.ghost")
    .addEventListener("click", () => editModal.close());
  document
    .getElementById("editForm")
    .addEventListener("submit", (e) => e.preventDefault());

  async function applyUpdateInfo(payload, mode, name, code, desc) {
    const r = await fetch(UPDATE_INFO_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const j = await r.json().catch(() => ({}));

    if (!r.ok) {
      // Duplicate case (NEW with existing name)
      if (r.status === 409 && j.warning) {
        const aggregate = j.aggregate || {};
        const perLine = aggregate.perLine || [];
        const list = perLine.map((m) => m.drawerCode).join(", ");
        const msg =
          `This product name already exists in: ${list || "other drawers"}.\n\n` +
          `Total quantity in stock: ${aggregate.totalQty ?? "?"}.\n\n` +
          `Do you want to link this drawer to the existing product definition (EXISTING mode)?`;

        if (window.confirm(msg)) {
          const payloadExisting = {
            drawerCode: payload.drawerCode,
            mode: "EXISTING",
            productName: name,
            productCode: code,
            description: desc,
          };
          return applyUpdateInfo(payloadExisting, "EXISTING", name, code, desc);
        } else {
          throw new Error("Duplicate name ‚Äì user cancelled");
        }
      }

      throw new Error(j.error || j.message || "Failed to update item info");
    }

    // Worker may normalise the fields
    const updated = j.drawerUpdated || {};
    const finalName = updated.productName || name || "";
    const finalCode = updated.productCode || code || "";
    const finalDesc = updated.description || desc || "";

    return { finalName, finalCode, finalDesc };
  }

  saveInfoBtn.addEventListener("click", async () => {
    if (!currentInfoDrawer) {
      editModal.close();
      return;
    }

    const drawerCode = currentInfoDrawer;
    let name = fldName.value.trim();
    let code = fldCode.value.trim();
    let desc = fldDesc.value.trim();
    const mode = (fldMode.value || "NEW").toUpperCase();

    const minStr = fldMinStock.value.trim();
    let minVal = null;
    if (minStr !== "") {
      const n = Number.parseInt(minStr, 10);
      if (!Number.isFinite(n) || n < 0) {
        showToast("Minimum stock must be a non-negative number", "#b3261e");
        return;
      }
      minVal = n;
    }

    // Validation per mode
    if (mode === "DESC_ONLY") {
      if (!desc && minVal === null) {
        showToast(
          "For DESCRIPTION ONLY mode, please update description and/or minimum stock",
          "#b3261e"
        );
        return;
      }
    } else if (mode === "EXISTING") {
      // Must choose an existing product
      ensureExistingPicker();
      if (!existingSelect) {
        showToast("Existing product picker not ready", "#b3261e");
        return;
      }
      const chosen = (existingSelect.value || "").trim();
      if (!chosen) {
        showToast("Please select an existing product from the list", "#b3261e");
        return;
      }
      const canon = canonicalByProductName(chosen);
      name = canon.productName || chosen;
      code = canon.productCode || "";
      desc = canon.description || "";

      fldName.value = name;
      fldCode.value = code;
      fldDesc.value = desc;
    } else {
      // NEW
      if (!name) {
        showToast("Product name is required in NEW/EXISTING mode", "#b3261e");
        return;
      }
    }

    // Build payload for worker
    let payload;
    if (mode === "DESC_ONLY") {
      payload = {
        drawerCode,
        mode: "DESC_ONLY",
        description: desc,
      };
    } else {
      payload = {
        drawerCode,
        mode,
        productName: name,
        productCode: code,
        description: desc,
      };
    }

    try {
      // 1) Update product info (name / code / desc) via worker
      const { finalName, finalCode, finalDesc } =
        await applyUpdateInfo(payload, mode, name, code, desc);

      // 2) Optional: update minStock via /stock/file if provided
      if (minVal !== null) {
        await updateMinStockForDrawer(drawerCode, minVal);
      }

      // 3) Update UI + ALL_DATA cache
      const block = document.querySelector(
        `.drawer-block[data-drawer="${drawerCode}"]`
      );
      if (block) {
        const nameLabel = block.querySelector(
          '[data-role="product-name-label"]'
        );
        const codeLabel = block.querySelector(
          '[data-role="product-code-label"]'
        );
        const descBox = block.querySelector(
          '[data-role="description-text"]'
        );
        const warn = block.querySelector('[data-role="minWarn"]');

        if (nameLabel)
          nameLabel.textContent = "Product name: " + finalName;
        if (codeLabel)
          codeLabel.innerHTML = "<strong>Code:</strong> " + finalCode;
        if (descBox) descBox.textContent = finalDesc;

        if (warn && minVal !== null) {
          warn.dataset.minStock = String(minVal);
          warn.textContent = "LOW STOCK ‚Äî minimum " + minVal;
        }

        // If it was an empty drawer, mark it as non-empty and expand
        block.classList.remove("empty");
        block.dataset.empty = "0";
        block.classList.remove("collapsed");
        const toggle = block.querySelector('[data-role="toggle-body"]');
        if (toggle) toggle.textContent = "‚ñæ";
      }

      const row = window.ALL_DATA.find(
        (r) => (r.drawerCode || "").trim() === drawerCode
      );
      if (row) {
        row.productName = finalName;
        row.productCode = finalCode;
        row.description = finalDesc;
        if (minVal !== null) row.minStock = String(minVal);
      }

      showToast(`‚úîÔ∏è Info updated for ${drawerCode}`);
      showPostSaveBanner(60);
      editModal.close();
    } catch (e) {
      console.error(e);
      showToast(
        "‚ùå Error updating info: " + (e.message || String(e)),
        "#b3261e"
      );
    }
  });

  /* ==============================
        QR MODAL
  =============================== */
  const qrModal   = document.getElementById("qrModal");
  const qrClose   = document.getElementById("qrClose");
  const qrCanvas  = document.getElementById("qrCanvas");
  const qrUrlNote = document.getElementById("qrUrlNote");
  const copyLinkBtn = document.getElementById("copyLinkBtn");
  const dlPngBtn    = document.getElementById("dlPngBtn");
  const dlPdfBtn    = document.getElementById("dlPdfBtn");

  let currentQrDrawer = null;
  let currentQrUrl = null;

  function openQrModalForDrawer(drawerCode) {
    currentQrDrawer = drawerCode;
    currentQrUrl = buildQrUrl(drawerCode);
    qrUrlNote.textContent = currentQrUrl;

    try {
      qrModal.showModal();
    } catch {
      qrModal.setAttribute("open", "");
    }

    (async () => {
      await new Promise((r) => requestAnimationFrame(r));
      await ensureQrLib();
      await drawQR(qrCanvas, currentQrUrl);
    })();
  }

  qrClose.addEventListener("click", () => qrModal.close());
  qrModal.addEventListener("click", (e) => {
    const r = qrModal.getBoundingClientRect();
    const inside =
      e.clientX >= r.left &&
      e.clientX <= r.right &&
      e.clientY >= r.top &&
      e.clientY <= r.bottom;
    if (!inside) qrModal.close();
  });

  copyLinkBtn.addEventListener("click", async () => {
    if (!currentQrUrl) return;
    try {
      await navigator.clipboard.writeText(currentQrUrl);
      showToast("üîó URL copied");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = currentQrUrl;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("üîó URL copied");
    }
  });

  dlPngBtn.addEventListener("click", () => {
    if (!currentQrDrawer) return;
    const a = document.createElement("a");
    a.href = qrCanvas.toDataURL("image/png");
    a.download = `${currentQrDrawer}_QR.png`;
    a.click();
  });

  dlPdfBtn.addEventListener("click", () => {
    if (!currentQrDrawer || !currentQrUrl) return;
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "mm", format: "A4" });
    const png = qrCanvas.toDataURL("image/png");
    const pageW = pdf.internal.pageSize.getWidth();
    const margin = 20;
    const box = pageW - margin * 2;
    pdf.addImage(png, "PNG", margin, margin, box, box);
    pdf.setFontSize(11);
    pdf.text(currentQrUrl, margin, 290);
    pdf.save(`${currentQrDrawer}_QR.pdf`);
  });
    /* ==============================
        STOCK + IMAGE + BLOCK
  =============================== */
  function buildDrawerHTML(drawerCode, row) {
    const name = row?.productName || "";
    const code = row?.productCode || "";
    const desc = row?.description || "";
    const qty  = parseInt(row?.stockQty || "0", 10);
    const min  = parseInt(row?.minStock || "10", 10);

    const isEmpty =
      !row ||
      (String(name).trim() === "" &&
        String(code).trim() === "" &&
        String(desc).trim() === "" &&
        (!row.stockQty || row.stockQty === "0"));

    const headerLabel = isEmpty
      ? "Empty drawer ‚Äî click Add product"
      : "Product name: " + name;

    const codeLabel = isEmpty ? "‚Äî" : code;
    const headerActions = isEmpty
      ? `<button class="btn" data-role="add-product">‚ûï Add product</button>`
      : `
         <button class="btn secondary" data-role="edit-info">‚úèÔ∏è Edit</button>
         <button class="btn ghost" data-role="qr">üìé QR</button>
         <button class="btn ghost" data-role="clear-drawer">üóëÔ∏è Clear drawer</button>
        `;

    const collapsedClass = isEmpty ? " collapsed empty" : "";

    return `
      <article class="drawer-block${collapsedClass}" data-drawer="${drawerCode}" data-empty="${isEmpty ? "1" : "0"}">
        <div class="drawer-header">
          <div class="drawer-header-left">
            <span class="drawer-code-pill">${drawerCode}</span>
            <span class="drawer-title-small" data-role="product-name-label">
              ${headerLabel}
            </span>
          </div>
          <div class="drawer-header-actions">
            ${headerActions}
            <button class="drawer-toggle" type="button" data-role="toggle-body">
              ${isEmpty ? "‚ñ∏" : "‚ñæ"}
            </button>
          </div>
        </div>

        <div class="drawer-body">
          <div class="row" style="font-size:12px;color:var(--muted);">
            <span data-role="product-code-label"><strong>Code:</strong> ${codeLabel}</span>
          </div>

          <div class="cards">
            <div class="card">
              <h3>Drawer photo</h3>
              <div class="card-inner">
                <div class="imgwrap">
                  <img data-role="drawer-img"
                       src="../images/${drawerCode}.jpg"
                       alt="Drawer image ${drawerCode}"
                       onerror="this.onerror=null; this.src='../../images/${drawerCode}.jpg';"/>
                </div>

                <div class="row" style="margin-top:8px;">
                  <button class="btn" data-role="upload-photo">üñºÔ∏è Update photo</button>
                  <button class="btn ghost" data-role="refresh-img">Refresh</button>
                  <span class="note">Saved automatically as <strong>${drawerCode}.jpg</strong></span>
                </div>
                <input type="file" accept="image/png,image/jpeg" data-role="file-input" style="display:none"/>
              </div>
            </div>
          </div>

          <div>
            <h3 style="font-size:14px;margin-top:8px;">Description</h3>
            <div class="description-box" data-role="description-text">${desc}</div>
          </div>

          <div class="stock-display" data-role="stock-display">üì¶ STOCK: ${qty}</div>

          <div class="stock-ui">
            <div class="row">
              <span class="pill">Current: <strong data-role="curQty">${qty}</strong></span>
              <span class="pill">Change: <strong data-role="delta">0</strong></span>
              <span class="pill">New: <strong data-role="newQty">${qty}</strong></span>
            </div>

            <div class="row" style="margin-top:8px;">
              <button type="button" class="btn" data-role="minus">‚àí1</button>
              <button type="button" class="btn" data-role="plus">+1</button>
              <label style="font-size:12px;">
                Exact:
                <input type="number" min="0" step="1" data-role="exact"/>
              </label>

              <button type="button" class="btn secondary" data-role="reset">Reset</button>
              <button type="button" class="btn" data-role="save-stock">Save</button>
            </div>

            <div class="warn" data-role="minWarn" data-min-stock="${min}">
              LOW STOCK ‚Äî minimum ${min}
            </div>
          </div>
        </div>
      </article>
    `;
  }

  function initStockUI(block, drawerCode) {
    const stockDisplay = block.querySelector('[data-role="stock-display"]');
    const curEl   = block.querySelector('[data-role="curQty"]');
    const deltaEl = block.querySelector('[data-role="delta"]');
    const newEl   = block.querySelector('[data-role="newQty"]');
    const minus   = block.querySelector('[data-role="minus"]');
    const plus    = block.querySelector('[data-role="plus"]');
    const exact   = block.querySelector('[data-role="exact"]');
    const reset   = block.querySelector('[data-role="reset"]');
    const saveBtn = block.querySelector('[data-role="save-stock"]');
    const warn    = block.querySelector('[data-role="minWarn"]');

    let cur = parseInt(curEl.textContent || "0", 10);
    let delta = 0;
    const minStock = parseInt(warn?.dataset.minStock || "0", 10);

    function refresh() {
      curEl.textContent = cur;
      deltaEl.textContent = delta > 0 ? "+" + delta : delta;
      const nv = cur + delta;
      newEl.textContent = nv;
      if (exact) exact.value = nv;
      if (stockDisplay) stockDisplay.textContent = "üì¶ STOCK: " + nv;

      if (warn) {
        if (nv < minStock) {
          warn.classList.add("pulse");
          warn.style.display = "block";
        } else {
          warn.classList.remove("pulse");
          warn.style.display = "none";
        }
      }
    }

    minus.addEventListener("click", () => {
      delta -= 1;
      refresh();
    });
    plus.addEventListener("click", () => {
      delta += 1;
      refresh();
    });
    exact.addEventListener("input", () => {
      const v = parseInt(exact.value, 10);
      if (!isNaN(v)) {
        delta = v - cur;
        refresh();
      }
    });
    reset.addEventListener("click", () => {
      delta = 0;
      refresh();
    });

    saveBtn.addEventListener("click", async () => {
      const newVal = cur + delta;
      if (
        !window.confirm(
          `Are you sure you want to update stock of ${drawerCode} to ${newVal}?`
        )
      )
        return;

      try {
        const r = await fetch(STOCK_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ drawerCode, newQty: newVal }),
        });
        if (!r.ok) throw new Error(await r.text());
        cur = newVal;
        delta = 0;
        refresh();

        const row = window.ALL_DATA.find(
          (r) => (r.drawerCode || "").trim() === drawerCode
        );
        if (row) row.stockQty = String(newVal);

        showToast(`‚úîÔ∏è Stock updated for ${drawerCode}`);
        showPostSaveBanner(60);
      } catch (e) {
        console.error(e);
        showToast("‚ùå Error updating stock", "#b3261e");
      }
    });

    refresh();
  }

  function initImageHandlers(block, drawerCode) {
    const img        = block.querySelector('[data-role="drawer-img"]');
    const uploadBtn  = block.querySelector('[data-role="upload-photo"]');
    const refreshBtn = block.querySelector('[data-role="refresh-img"]');
    const fileInput  = block.querySelector('[data-role="file-input"]');

    function refreshCache() {
      const base = img.getAttribute("src").split("?")[0];
      img.src = base + "?v=" + Date.now();
    }

    uploadBtn.addEventListener("click", () => fileInput.click());
    refreshBtn.addEventListener("click", () => refreshCache());

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      if (!/image\/jpe?g|image\/png/i.test(file.type)) {
        showToast("Accepted formats: JPG or PNG", "#b3261e");
        return;
      }
      if (file.size > 8 * 1024 * 1024) {
        showToast("Max 8MB image", "#b3261e");
        return;
      }

      const fd = new FormData();
      fd.append("image", file);
      fd.append("drawerCode", drawerCode);

      try {
        const r = await fetch(UPLOAD_ENDPOINT, { method: "POST", body: fd });
        if (!r.ok) throw new Error(await r.text());
        showToast(`‚úîÔ∏è Image updated for ${drawerCode}`);
        refreshCache();
        showPostSaveBanner(60);
      } catch (err) {
        console.error(err);
        showToast("‚ùå Error uploading image", "#b3261e");
      } finally {
        fileInput.value = "";
      }
    });
  }

  /* ==============================
        DRAWER INTERACTIONS
  =============================== */
  function initDrawerInteractions(block, drawerCode, row) {
    const toggleBtn = block.querySelector('[data-role="toggle-body"]');
    const body      = block.querySelector(".drawer-body");
    const addBtn    = block.querySelector('[data-role="add-product"]');
    const clearBtn  = block.querySelector('[data-role="clear-drawer"]');

    function setCollapsed(c) {
      if (c) block.classList.add("collapsed");
      else   block.classList.remove("collapsed");
    }

    if (toggleBtn && body) {
      toggleBtn.addEventListener("click", () => {
        const collapsed = !block.classList.contains("collapsed");
        setCollapsed(collapsed);
        toggleBtn.textContent = collapsed ? "‚ñ∏" : "‚ñæ";
      });
    }

    if (addBtn) {
      addBtn.addEventListener("click", () => {
        setCollapsed(false);
        if (body) body.scrollIntoView({ behavior: "smooth", block: "center" });
        openEditModalForDrawer(drawerCode, null);
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", async () => {
        if (
          !window.confirm(
            `Clear ALL product data for ${drawerCode}? This will reset product, description, stock and min stock.`
          )
        ) {
          return;
        }
        try {
          const r = await fetch(RESET_DRAWER_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ drawerCode }),
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) {
            throw new Error(j.error || "Failed to clear drawer");
          }

          // Update local cache
          const rowLocal = window.ALL_DATA.find(
            (rr) => (rr.drawerCode || "").trim() === drawerCode
          );
          if (rowLocal) {
            rowLocal.productName = "";
            rowLocal.productCode = "";
            rowLocal.description = "";
            rowLocal.stockQty = "0";
            rowLocal.minStock = rowLocal.minStock || "10";
          }

          // Update UI
          const nameLabel = block.querySelector(
            '[data-role="product-name-label"]'
          );
          const codeLabel = block.querySelector(
            '[data-role="product-code-label"]'
          );
          const descBox = block.querySelector(
            '[data-role="description-text"]'
          );
          const curQtyEl = block.querySelector('[data-role="curQty"]');
          const newQtyEl = block.querySelector('[data-role="newQty"]');
          const stockDisplay = block.querySelector(
            '[data-role="stock-display"]'
          );
          const warn = block.querySelector('[data-role="minWarn"]');

          if (nameLabel)
            nameLabel.textContent = "Empty drawer ‚Äî click Add product";
          if (codeLabel) codeLabel.innerHTML = "<strong>Code:</strong> ‚Äî";
          if (descBox) descBox.textContent = "";
          if (curQtyEl) curQtyEl.textContent = "0";
          if (newQtyEl) newQtyEl.textContent = "0";
          if (stockDisplay) stockDisplay.textContent = "üì¶ STOCK: 0";
          if (warn) {
            warn.classList.remove("pulse");
            warn.style.display = "none";
          }

          block.classList.add("empty");
          block.dataset.empty = "1";
          setCollapsed(true);
          if (toggleBtn) toggleBtn.textContent = "‚ñ∏";

          showToast(`‚úîÔ∏è Cleared drawer ${drawerCode}`);
          showPostSaveBanner(60);
        } catch (e) {
          console.error(e);
          showToast("‚ùå Error clearing drawer", "#b3261e");
        }
      });
    }
  }

  /* ==============================
        GROUP VARIANT UI
  =============================== */
  function initVariantUI() {
    document.querySelectorAll(".variant-controls").forEach((ctrl) => {
      const base = ctrl.getAttribute("data-variant-base");
      const addBtn = ctrl.querySelector('[data-role="add-variant"]');
      const listEl = ctrl.querySelector('[data-role="variant-list"]');

      async function refreshList() {
        try {
          const v = await loadVariants(base);
          listEl.textContent = "Variants: " + v.join(", ");
        } catch (e) {
          console.error(e);
          listEl.textContent = "Error loading variants";
        }
      }

      addBtn.addEventListener("click", async () => {
        try {
          const newCode = await addVariant(base);
          showToast(`‚úîÔ∏è Variant created: ${newCode}`);
          showPostSaveBanner(60);
          await renderGroup(base);
          await refreshList();
        } catch (e) {
          console.error(e);
          showToast("‚ùå Error adding variant", "#b3261e");
        }
      });

      refreshList();
    });
  }

  /* ==============================
        RENDER GROUP
  =============================== */
  async function renderGroup(base) {
    const container = document.querySelector(
      `[data-container="${base}"]`
    );
    if (!container) return;

    container.innerHTML = "Loading‚Ä¶";

    const variants = await loadVariants(base);
    const drawers = variants.map((v) => `${base}_${v}`);
    const rows = window.ALL_DATA;

    container.innerHTML = drawers
      .map((dc) => {
        const row = rows.find((r) => (r.drawerCode || "").trim() === dc);
        return buildDrawerHTML(dc, row);
      })
      .join("");

    drawers.forEach((dc) => {
      const block = container.querySelector(
        `.drawer-block[data-drawer="${dc}"]`
      );
      const row = rows.find((r) => (r.drawerCode || "").trim() === dc);
      if (!block) return;

      initStockUI(block, dc);
      initImageHandlers(block, dc);
      initDrawerInteractions(block, dc, row);

      const editBtn = block.querySelector('[data-role="edit-info"]');
      const qrBtn   = block.querySelector('[data-role="qr"]');

      if (editBtn)
        editBtn.addEventListener("click", () =>
          openEditModalForDrawer(dc, row)
        );
      if (qrBtn)
        qrBtn.addEventListener("click", () =>
          openQrModalForDrawer(dc)
        );
    });
  }

  /* ==============================
        BOOTSTRAP
  =============================== */
  (async function bootstrap() {
    try {
      window.ALL_DATA = await loadCSV();

      for (const base of GROUPS) {
        await renderGroup(base);
      }

      initVariantUI();
    } catch (e) {
      console.error(e);
      showToast("‚ùå Error loading Rack B", "#b3261e");
    }
  })();
  </script>
</body>
</html>
